<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Supply Chain AI Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; color: #2c3e50; margin: 0; padding: 0; }
        html, body { height: 100%; overflow-x: hidden; }
        body.security-active { overflow: hidden; height: 100vh; }
        
        /* SVG Icon Styles */
        .icon-svg { display: inline-block; width: 1.2em; height: 1.2em; vertical-align: middle; margin-right: 0.3em; }
        .icon-svg-lg { width: 1.7em; height: 1.7em; }
        .icon-svg-xl { width: 2.2em; height: 2.2em; }
        .icon-svg-sm { width: 1.5em; height: 1.5em; }
        
        /* Farm-specific layout: Cards side by side */
        .farm-stage-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            align-items: stretch;
        }
        @media (max-width: 1200px) {
            .farm-stage-container {
                grid-template-columns: 1fr;
            }
        }
        .farm-stage-cards {
            display: contents;
        }
        .farm-stage-cards .farm-card,
        .farm-stage-cards .ai-suggestion-box {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .farm-card {
            min-height: 100%;
        }
        .ai-suggestion-box {
            min-height: 100%;
            display: flex !important;
            flex-direction: column;
        }
        .farm-stage-charts {
            grid-column: 1 / -1;
            width: 100%;
        }
        .header { background: linear-gradient(135deg, #1a5f7a 0%, #0f3a4f 100%); color: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 200; min-height: 120px; display: flex; align-items: center; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: nowrap; width: 100%; }
        .header-left { display: flex; flex-direction: column; gap: 12px; }
        .header h1 { font-size: 22px; margin: 0; white-space: nowrap; }
        .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; margin-left: auto; }
        .header-subtitle { font-size: 14px; opacity: 0.9; white-space: nowrap; font-weight: 500; }
        .ai-badge { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 12px; white-space: nowrap; font-weight: 500; }
        .farm-tabs { display: flex; gap: 8px; align-items: center; }
        .farm-tab { padding: 6px 16px; background: rgba(255,255,255,0.2); border: 2px solid transparent; border-radius: 5px; cursor: pointer; transition: all 0.3s; font-weight: 600; font-size: 12px; white-space: nowrap; }
        .farm-tab:hover { background: rgba(255,255,255,0.3); }
        .farm-tab.active { background: white; color: #1a5f7a; border-color: white; }
        .container { max-width: 100%; margin: 0; padding: 0; padding-top: 140px; }
        body.security-active .container { padding-top: 120px; }
        .sidebar { position: fixed; left: 0; top: 120px; width: 250px; height: calc(100vh - 120px); background: #f5f5f5; border-right: 1px solid #ddd; overflow-y: auto; z-index: 100; }
        .sidebar-item { padding: 15px 20px; cursor: pointer; border-left: 3px solid transparent; transition: all 0.3s; color: #2c3e50; font-weight: 500; }
        .sidebar-item:hover { background: #ecf0f1; border-left-color: #27ae60; }
        .sidebar-item.active { background: #d5dbdb; border-left-color: #1a5f7a; color: #1a5f7a; font-weight: 600; }
        .sidebar-item.active:hover { background: #cacfd2; border-left-color: #1a5f7a; }
        .main-content { margin-left: 250px; padding: 20px; width: calc(100% - 250px); box-sizing: border-box; height: calc(100vh - 140px); overflow-y: auto; }
        body.security-active .main-content { overflow: hidden; height: calc(100vh - 120px); padding: 0; }
        .section { display: none; width: 100%; }
        .section.active { display: block; width: 100%; }
        .section-title { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .ai-sparkle { animation: sparkle 2s infinite; font-size: 20px; }
        @keyframes sparkle { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-top: 4px solid #1a5f7a; position: relative; }
        .kpi-card.warning { border-top-color: #e74c3c; }
        .kpi-card.success { border-top-color: #27ae60; }
        .kpi-card.danger { border-top-color: #c0392b; }
        .kpi-label { color: #7f8c8d; font-size: 12px; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .kpi-value { font-size: 28px; font-weight: bold; color: #1a5f7a; }
        .kpi-unit { font-size: 12px; color: #95a5a6; margin-top: 5px; }
        .ai-insight { font-size: 10px; color: #27ae60; margin-top: 8px; padding-top: 8px; border-top: 1px solid #ecf0f1; font-style: italic; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .insight-icon { font-size: 12px; margin-right: 4px; animation: sparkle 2s infinite; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .chart-container h3 { color: #1a5f7a; margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .chart-wrapper { position: relative; height: 300px; }
        .ai-suggestion-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 12px; margin-top: 20px; display: flex; gap: 12px; overflow: visible; height: auto; min-height: auto; max-height: none; }
        .overview-single-farm .ai-suggestion-box { margin-top: 0; }
        .farm-stage-container .ai-suggestion-box,
        .farm-stage-cards .ai-suggestion-box { margin-top: 0; }
        /* Hide any AI suggestion boxes that might appear outside containers in farm-specific views (but keep them in farm-stage-cards) */
        .section:not(#overview) > .ai-suggestion-box:not(.farm-stage-cards .ai-suggestion-box):not(.farm-stage-container .ai-suggestion-box) { display: none !important; }
        /* Hide Overview AI Insights box when Overview section is not active */
        #overview:not(.active) #overviewSuggestion { display: none !important; }
        /* Hide Overview AI Insights box by default - will be shown via JavaScript only for "All Farms" in Overview */
        #overviewSuggestion { display: none !important; }
        .ai-suggestion-box .icon { font-size: 24px; flex-shrink: 0; animation: sparkle 2s infinite; }
        .ai-suggestion-box .content { flex: 1; overflow: visible; display: flex; flex-direction: column; min-height: 0; }
        .ai-suggestion-box h4 { font-size: 14px; margin-bottom: 8px; white-space: normal; word-wrap: break-word; }
        .ai-suggestion-box p { font-size: 13px; opacity: 0.9; line-height: 1.6; white-space: pre-line; word-wrap: break-word; overflow-wrap: break-word; flex: 1; }
        .ai-insight-item { margin: 4px 0; padding: 2px 0; white-space: normal; word-wrap: break-word; }
        .ai-suggestion-box .content > div:not(.sections-grid) { flex: 1; display: flex; flex-direction: column; }
        .ai-suggestion-box.side-by-side { flex-direction: row; }
        .ai-suggestion-box.side-by-side .content { 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            flex: 1;
        }
        .ai-suggestion-box.side-by-side .content h4 {
            margin-bottom: 12px;
            width: 100%;
            flex-shrink: 0;
        }
        .ai-suggestion-box.side-by-side .content .sections-grid {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 20px;
            width: 100%;
            align-items: flex-start;
            margin-top: 0;
        }
        .ai-suggestion-box.side-by-side .insights-section,
        .ai-suggestion-box.side-by-side .recommendations-section { 
            display: flex !important; 
            flex-direction: column !important; 
            width: 100%;
            min-width: 0;
        }
        .ai-suggestion-box.side-by-side .insights-section h5,
        .ai-suggestion-box.side-by-side .recommendations-section h5 { 
            font-size: 13px; 
            margin-bottom: 8px; 
            margin-top: 0;
            font-weight: 600; 
            opacity: 0.95; 
        }
        .ai-suggestion-box.side-by-side .insights-section > div,
        .ai-suggestion-box.side-by-side .recommendations-section > div {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .details-button { background: #27ae60; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; margin-top: 20px; display: inline-flex; align-items: center; gap: 8px; }
        .details-button:hover { background: #229954; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .farm-comparison { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px; 
            margin-bottom: 30px; 
            width: 100%;
            max-width: 100%;
            justify-items: stretch;
            align-items: stretch;
            box-sizing: border-box;
        }
        @media (max-width: 1400px) {
            .farm-comparison { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .farm-comparison { grid-template-columns: 1fr; }
        }
        .farm-comparison > .farm-card {
            width: 100%;
            max-width: 100%;
            min-width: 0;
            height: 100%;
        }
        .single-farm-card-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 30px;
        }
        .single-farm-card-container .farm-card {
            max-width: 500px;
            width: 100%;
        }
        .farm-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
            padding: 0; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            overflow: hidden; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            min-height: auto;
            height: auto;
            width: 100%;
            box-sizing: border-box;
        }
        .farm-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 30px rgba(0,0,0,0.15); 
        }
        .farm-card-header { 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: visible;
            min-height: auto;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .farm-card.excellent .farm-card-header { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
        .farm-card.good .farm-card-header { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .farm-card.average .farm-card-header { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .farm-card.poor .farm-card-header { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .farm-card-header h3 { 
            color: white; 
            margin: 0; 
            font-size: 20px; 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
            overflow: visible;
            min-width: 0;
            width: 100%;
            flex-shrink: 0;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .farm-card-body { 
            padding: 20px; 
            flex: 1;
            overflow: visible;
            min-height: auto;
            width: 100%;
            box-sizing: border-box;
        }
        .performance-score-container { 
            display: flex; 
            align-items: baseline; 
            gap: 5px; 
            margin: 0;
            flex-shrink: 0;
        }
        .performance-score { 
            font-size: 42px; 
            font-weight: 800; 
            color: white;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .performance-score-label { 
            font-size: 16px; 
            color: rgba(255,255,255,0.95); 
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .status-badge { 
            display: inline-block; 
            padding: 6px 14px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(255,255,255,0.3);
            color: white;
            backdrop-filter: blur(10px);
            white-space: nowrap;
            text-align: center;
            margin: 0;
            width: auto;
            max-width: 100%;
            line-height: 1.4;
            overflow: visible;
            flex-shrink: 0;
            align-self: flex-start;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .metric-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px 0; 
            border-bottom: 1px solid #f0f0f0; 
            min-height: 40px;
            gap: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        .metric-row:last-child { 
            border-bottom: none; 
        }
        .metric-label { 
            color: #2c3e50; 
            font-size: 14px; 
            font-weight: 600;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            flex: 1;
            margin-right: 10px;
            min-width: 0;
            overflow: visible;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .metric-value { 
            font-weight: 700; 
            color: #1a5f7a; 
            font-size: 15px;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: right;
            flex-shrink: 0;
            min-width: 0;
            overflow: visible;
        }
        .farm-card .kpi-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 10px; 
            margin-top: 10px; 
        }
        .farm-card .kpi-card { 
            padding: 12px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            border: 1px solid #e9ecef;
        }
        .farm-card .kpi-card.success { 
            background: linear-gradient(135deg, #d5f4e6 0%, #c8e6d5 100%); 
            border-color: #27ae60; 
        }
        .farm-card .kpi-card.warning { 
            background: linear-gradient(135deg, #fef5e7 0%, #fdebd0 100%); 
            border-color: #f39c12; 
        }
        .overview-single-farm-container {
            width: 100%;
            display: block;
        }
        .overview-single-farm-container .farm-stage-container {
            width: 100%;
            max-width: 100%;
        }
        .overview-single-farm { 
            display: flex;
            justify-content: center;
            align-items: start;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        .overview-single-farm .farm-card { 
            margin: 0; 
            width: 100%;
            max-width: 600px;
        }
        @media (max-width: 768px) {
            .overview-single-farm { 
                max-width: 100%;
            }
        }
        /* Chatbot Styles */
        .chatbot-toggle { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; transition: transform 0.3s; }
        .chatbot-toggle:hover { transform: scale(1.1); }
        .chatbot-toggle svg { width: 28px; height: 28px; fill: white; pointer-events: none; }
        .chatbot-container { position: fixed; bottom: 90px; right: 20px; width: 380px; height: 500px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); z-index: 1000; display: none; flex-direction: column; overflow: hidden; }
        .chatbot-container.active { display: flex; }
        .chatbot-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .chatbot-header h3 { margin: 0; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .chatbot-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
        .chatbot-messages { flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; }
        .chatbot-message { margin-bottom: 12px; display: flex; gap: 8px; }
        .chatbot-message.user { flex-direction: row-reverse; }
        .chatbot-message-content { max-width: 75%; padding: 10px 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; }
        .chatbot-message.bot .chatbot-message-content { background: white; color: #2c3e50; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chatbot-message.user .chatbot-message-content { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .chatbot-input-container { padding: 15px; background: white; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; }
        .chatbot-input { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; outline: none; }
        .chatbot-input:focus { border-color: #667eea; }
        .chatbot-send { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; transition: opacity 0.3s; }
        .chatbot-send:hover { opacity: 0.9; }
        .chatbot-send:disabled { opacity: 0.5; cursor: not-allowed; }
        .chatbot-typing { display: flex; gap: 4px; padding: 10px 12px; }
        .chatbot-typing span { width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: typing 1.4s infinite; }
        .chatbot-typing span:nth-child(2) { animation-delay: 0.2s; }
        .chatbot-typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.7; } 30% { transform: translateY(-10px); opacity: 1; } }
        @media (max-width: 768px) { 
            .header-content { flex-direction: column; gap: 10px; align-items: flex-start; }
            .header-left { flex-direction: column; gap: 10px; width: 100%; }
            .header-right { align-items: flex-start; width: 100%; }
            .farm-tabs { width: 100%; flex-wrap: wrap; }
            .sidebar { width: 100%; height: auto; position: relative; top: 0; border-bottom: 1px solid #ddd; } 
            .main-content { margin-left: 0; } 
            .kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .farm-comparison { grid-template-columns: 1fr; }
        }

        /* Security Section - Large Video Feed Styles */
        #security.section {
            display: none; /* Hide by default - only show when active */
        }
        #security.section.active {
            margin: 0;
            width: 100%;
            height: 100%;
            min-height: 100%;
            max-height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #security-container {
            padding: 0 !important;
            margin: 0;
            width: 100%;
            height: 100%;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #security .section-title {
            margin: 0;
            padding: 10px 20px 8px 20px;
            flex-shrink: 0;
        }
        #security #security-container > div:first-child {
            margin: 0 20px 8px 20px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-shrink: 0;
        }
        #security #security-container > div:first-child h3 {
            margin: 0 0 8px 0;
            font-size: 15px;
            color: #1a5f7a;
        }
        #security #security-container > div:first-child > div {
            margin-bottom: 4px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        #security #security-container > div:first-child p {
            margin: 4px 0 0 0;
            font-size: 11px;
            color: #7f8c8d;
        }
        #security-feed-wrapper {
            display: flex;
            gap: 20px;
            width: 100%;
            height: 100%;
            flex: 1;
            min-height: 0;
            max-height: 100%;
            padding: 0 20px 20px 20px;
            overflow: hidden;
        }
        #espcam-feed-container {
            position: relative;
            width: 65%;
            background: #f5f7fa;
            border-radius: 12px;
            margin: 0;
            padding: 20px;
            min-height: 0;
            height: 100%;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #notification-center {
            width: 35%;
            background: white;
            border-radius: 12px;
            height: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #notification-center-header {
            flex-shrink: 0;
            padding: 20px;
            border-bottom: 2px solid #ecf0f1;
            background: white;
            border-radius: 12px 12px 0 0;
        }
        #notification-center h3 {
            color: #1a5f7a;
            margin: 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #notification-center-header svg {
            width: 20px;
            height: 20px;
            fill: #1a5f7a;
            flex-shrink: 0;
        }
        #notifications-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px 20px 20px;
            min-height: 0;
        }
        .notification-item {
            background: #f8f9fa;
            border-left: 4px solid #e74c3c;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 12px;
            transition: all 0.3s;
            cursor: pointer;
        }
        .notification-item:hover {
            background: #ecf0f1;
            transform: translateX(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .notification-item.motion {
            border-left-color: #e74c3c;
        }
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .notification-type {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        .notification-time {
            font-size: 11px;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
        }
        .notification-message {
            font-size: 13px;
            color: #34495e;
            line-height: 1.4;
        }
        .notification-empty {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }
        .notification-empty p {
            margin: 10px 0;
            font-size: 14px;
        }
        #espcam-stream {
            width: 90% !important;
            max-width: 100% !important;
            height: 85% !important;
            max-height: 900px !important;
            min-height: 500px !important;
            border: none !important;
            border-radius: 12px;
            background: #000;
            display: none;
            position: relative !important;
            margin: auto !important;
            padding: 0 !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        #espcam-stream-img {
            width: 90% !important;
            max-width: 1400px !important;
            height: 85% !important;
            max-height: 900px !important;
            min-height: 500px !important;
            object-fit: contain !important;
            object-position: center center !important;
            border-radius: 12px;
            background: #000;
            display: none;
            position: relative !important;
            margin: auto !important;
            padding: 0 !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            image-rendering: auto !important;
        }
        #espcam-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            color: #2c3e50;
            text-align: center;
            pointer-events: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        @media (max-width: 1200px) {
            #security.section.active {
                height: 100%;
                min-height: 100%;
                max-height: 100%;
            }
            #espcam-stream,
            #espcam-stream-img {
                width: 85% !important;
                max-width: 1200px !important;
                max-height: 800px !important;
            }
        }
        @media (max-width: 1200px) {
            #security-feed-wrapper {
                gap: 15px;
            }
            #espcam-feed-container {
                width: 60%;
            }
            #notification-center {
                width: 40%;
            }
        }
        @media (max-width: 768px) {
            #security.section.active {
                height: 100%;
                min-height: 100%;
                max-height: 100%;
            }
            #security-feed-wrapper {
                flex-direction: column;
                gap: 15px;
                padding: 0 10px 10px 10px;
            }
            #espcam-feed-container {
                width: 100%;
                height: 50%;
                min-height: 300px;
                padding: 15px;
            }
            #notification-center {
                width: 100%;
                height: 50%;
                min-height: 300px;
            }
            #espcam-stream,
            #espcam-stream-img {
                width: 95% !important;
                max-width: 100% !important;
                max-height: 600px !important;
                border-radius: 8px;
            }
            #security #security-container > div:first-child {
                margin: 0 10px 6px 10px;
                padding: 8px;
            }
            #security .section-title {
                padding: 8px 10px 6px 10px;
            }
            #security #security-container > div:first-child > div {
                gap: 6px;
            }
            #security #security-container > div:first-child input,
            #security #security-container > div:first-child button {
                font-size: 12px;
                padding: 6px 10px;
            }
            #espcam-status {
                padding: 20px 30px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-left">
            <h1>ðŸŒ¾ Food Supply Chain AI Platform</h1>
                <div class="farm-tabs">
                    <div class="farm-tab" onclick="switchFarm('all', this)">All Farms</div>
                    <div class="farm-tab" onclick="switchFarm('FarmA', this)">Farm A</div>
                    <div class="farm-tab" onclick="switchFarm('FarmB', this)">Farm B</div>
                    <div class="farm-tab" onclick="switchFarm('FarmC', this)">Farm C</div>
                    <div class="farm-tab" onclick="switchFarm('FarmD', this)">Farm D</div>
        </div>
            </div>
            <div class="header-right">
                <div class="header-subtitle">AI-Powered Analytics Dashboard</div>
        <div class="ai-badge"><span id="header-ai-icon"></span> AI Insights Enabled</div>
            </div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-item active" data-section="overview" onclick="showSection('overview')"><span id="sidebar-overview-icon"></span>Overview</div>
        <div class="sidebar-item" data-section="production" onclick="showSection('production')"><span id="sidebar-production-icon"></span>Production</div>
        <div class="sidebar-item" data-section="storage" onclick="showSection('storage')"><span id="sidebar-storage-icon"></span>Storage</div>
        <div class="sidebar-item" data-section="processing" onclick="showSection('processing')"><span id="sidebar-processing-icon"></span>Processing</div>
        <div class="sidebar-item" data-section="transportation" onclick="showSection('transportation')"><span id="sidebar-transportation-icon"></span>Transport</div>
        <div class="sidebar-item" data-section="retail" onclick="showSection('retail')"><span id="sidebar-retail-icon"></span>Retail</div>
        <div class="sidebar-item" data-section="consumption" onclick="showSection('consumption')"><span id="sidebar-consumption-icon"></span>Consumption</div>
        <div class="sidebar-item" data-section="waste" onclick="showSection('waste')"><span id="sidebar-waste-icon"></span>Waste</div>
        <div class="sidebar-item" data-section="security" onclick="showSection('security')"><span id="sidebar-security-icon"></span>Security</div>
    </div>

    <div class="container">
        <div class="main-content">
            <div id="overview" class="section active">
                <div class="section-title"><h2 style="color: #1a5f7a; display: flex; align-items: center; gap: 8px;"><span id="overview-title-icon"></span>Farm Comparison Overview</h2><span id="overview-sparkle-icon"></span></div>
                <div id="farm-comparison-container" class="farm-comparison"></div>
                <div class="ai-suggestion-box" id="overviewSuggestion"></div>
                <div class="stats-row">
                    <div class="chart-container"><h3><span id="chart1-sparkle-icon"></span>Yield Comparison</h3><div class="chart-wrapper"><canvas id="overviewChart1"></canvas></div></div>
                    <div class="chart-container"><h3><span id="chart2-sparkle-icon"></span>Spoilage Comparison</h3><div class="chart-wrapper"><canvas id="overviewChart2"></canvas></div></div>
                </div>
                <div class="stats-row">
                    <div class="chart-container"><h3><span id="chart3-sparkle-icon"></span>Performance Score</h3><div class="chart-wrapper"><canvas id="overviewChart3"></canvas></div></div>
                    <div class="chart-container"><h3><span id="chart4-sparkle-icon"></span>Defect Rate Comparison</h3><div class="chart-wrapper"><canvas id="overviewChart4"></canvas></div></div>
                </div>
            </div>

            <div id="production" class="section">
                <div class="section-title"><h2 style="color: #1a5f7a; display: flex; align-items: center; gap: 8px;"><span id="production-title-icon"></span>Production Stage</h2><span id="production-sparkle-icon"></span></div>
                <div id="production-container"></div>
                <div class="chart-container farm-stage-charts"><h3><span id="production-chart-sparkle-icon"></span>Average Yield by Crop</h3><div class="chart-wrapper"><canvas id="productionChart1"></canvas></div></div>
                <button class="details-button" onclick="viewFarmDetails('production')"><span id="production-button-icon"></span>View Production Details</button>
            </div>

            <div id="storage" class="section">
                <div class="section-title"><h2 style="color: #1a5f7a; display: flex; align-items: center; gap: 8px;"><span id="storage-title-icon"></span>Storage & Post-Harvest</h2><span id="storage-sparkle-icon"></span></div>
                <div id="storage-container"></div>
                <div class="chart-container farm-stage-charts"><h3><span id="storage-chart-sparkle-icon"></span>Storage Metrics</h3><div class="chart-wrapper"><canvas id="storageChart1"></canvas></div></div>
                <button class="details-button" onclick="viewFarmDetails('storage')"><span id="storage-button-icon"></span>View Storage Details</button>
            </div>

            <div id="processing" class="section">
                <div class="section-title"><h2 style="color: #1a5f7a; display: flex; align-items: center; gap: 8px;"><span id="processing-title-icon"></span>Processing & Packaging</h2><span id="processing-sparkle-icon"></span></div>
                <div id="processing-container"></div>
                <div class="chart-container farm-stage-charts"><h3><span id="processing-chart-sparkle-icon"></span>Defect Rate by Process</h3><div class="chart-wrapper"><canvas id="processingChart1"></canvas></div></div>
                <button class="details-button" onclick="viewFarmDetails('processing')"><span id="processing-button-icon"></span>View Processing Details</button>
            </div>

            <div id="transportation" class="section">
                <div class="section-title"><h2 style="color: #1a5f7a; display: flex; align-items: center; gap: 8px;"><span id="transportation-title-icon"></span>Distribution & Transportation</h2><span id="transportation-sparkle-icon"></span></div>
                <div id="transportation-container"></div>
                <div class="chart-container farm-stage-charts"><h3><span id="transportation-chart-sparkle-icon"></span>Transportation Metrics</h3><div class="chart-wrapper"><canvas id="transChart1"></canvas></div></div>
                <button class="details-button" onclick="viewFarmDetails('transportation')"><span id="transportation-button-icon"></span>View Transportation Details</button>
            </div>

            <div id="retail" class="section">
                <div class="section-title"><h2 style="color: #1a5f7a; display: flex; align-items: center; gap: 8px;"><span id="retail-title-icon"></span>Retail Insights</h2><span id="retail-sparkle-icon"></span></div>
                <div id="retail-container"></div>
                <div class="chart-container farm-stage-charts"><h3><span id="retail-chart-sparkle-icon"></span>Inventory & Sales</h3><div class="chart-wrapper"><canvas id="retailChart1"></canvas></div></div>
                <button class="details-button" onclick="viewFarmDetails('retail')"><span id="retail-button-icon"></span>View Retail Details</button>
            </div>

            <div id="consumption" class="section">
                <div class="section-title"><h2 style="color: #1a5f7a; display: flex; align-items: center; gap: 8px;"><span id="consumption-title-icon"></span>Consumption & Household</h2><span id="consumption-sparkle-icon"></span></div>
                <div id="consumption-container"></div>
                <div class="chart-container farm-stage-charts"><h3><span id="consumption-chart-sparkle-icon"></span>Household Metrics</h3><div class="chart-wrapper"><canvas id="consumptionChart1"></canvas></div></div>
                <button class="details-button" onclick="viewFarmDetails('consumption')"><span id="consumption-button-icon"></span>View Consumption Details</button>
            </div>

            <div id="waste" class="section">
                <div class="section-title"><h2 style="color: #1a5f7a; display: flex; align-items: center; gap: 8px;"><span id="waste-title-icon"></span>Waste Management</h2><span id="waste-sparkle-icon"></span></div>
                <div id="waste-container"></div>
                <div class="chart-container farm-stage-charts"><h3><span id="waste-chart-sparkle-icon"></span>Waste Distribution</h3><div class="chart-wrapper"><canvas id="wasteChart1"></canvas></div></div>
                <button class="details-button" onclick="viewFarmDetails('waste')"><span id="waste-button-icon"></span>View Waste Details</button>
            </div>

            <div id="security" class="section">
                <div class="section-title"><h2 style="color: #1a5f7a; display: flex; align-items: center; gap: 8px;"><span id="security-title-icon"></span>Security Camera Feed</h2><span id="security-sparkle-icon"></span></div>
                <div id="security-container">
                    <div>
                        <h3>ESPCam Configuration</h3>
                        <div>
                            <input type="text" id="espcam-ip" placeholder="ESP32 Camera IP Address" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; flex: 1; min-width: 180px; font-size: 13px;">
                            <input type="text" id="espcam-port" placeholder="Port" value="81" style="padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; width: 90px; font-size: 13px;">
                            <button id="espcam-connect-btn" onclick="connectESPCam()" style="padding: 8px 18px; background: #1a5f7a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s;">Connect</button>
                            <button id="espcam-disconnect-btn" onclick="disconnectESPCam()" style="padding: 8px 18px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.3s;">Disconnect</button>
                        </div>
                        <p>Enter your ESP32 camera IP address and port to view the live feed.</p>
                    </div>
                    <div id="security-feed-wrapper">
                        <div id="espcam-feed-container">
                            <div id="espcam-status">
                                <p style="font-size: 24px; margin-bottom: 12px;">ðŸ“¹ Camera Feed</p>
                                <p style="font-size: 16px; color: #7f8c8d;">Configure and connect to view live feed</p>
                            </div>
                            <iframe id="espcam-stream" src="" title="ESPCam Live Stream"></iframe>
                            <img id="espcam-stream-img" src="" alt="ESPCam Stream">
                        </div>
                        <div id="notification-center">
                            <div id="notification-center-header">
                                <h3>
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" fill="#1a5f7a" stroke="#1a5f7a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#1a5f7a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        <circle cx="16" cy="8" r="2" fill="#e74c3c"/>
                                    </svg>
                                    Security Alerts
                                </h3>
                            </div>
                            <div id="notifications-list">
                                <!-- Notifications will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // SVG Icon Definitions
        const icons = {
            production: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#27ae60" stroke="#1e8449" stroke-width="1.5"/><path d="M2 17L12 22L22 17" stroke="#1e8449" stroke-width="1.5" stroke-linecap="round"/><path d="M2 12L12 17L22 12" stroke="#1e8449" stroke-width="1.5" stroke-linecap="round"/></svg>',
            storage: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="8" width="18" height="12" rx="2" fill="#3498db" stroke="#2980b9" stroke-width="1.5"/><path d="M3 10C3 8.89543 3.89543 8 5 8H19C20.1046 8 21 8.89543 21 10V11H3V10Z" fill="#2980b9"/><path d="M8 5L12 2L16 5" stroke="#2980b9" stroke-width="1.5" stroke-linecap="round"/><path d="M12 2V8" stroke="#2980b9" stroke-width="1.5"/></svg>',
            processing: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="8" fill="#e67e22" stroke="#d35400" stroke-width="1.5"/><path d="M12 6V12L16 14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>',
            transportation: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="6" width="14" height="11" fill="#e74c3c" stroke="#c0392b" stroke-width="1.2" rx="0.5"/><rect x="17" y="8" width="5" height="9" fill="#95a5a6" stroke="#7f8c8d" stroke-width="1.2" rx="0.5"/><path d="M3 16H15V17H3V16Z" fill="#c0392b" opacity="0.8"/><path d="M3 12H15V13H3V12Z" fill="#c0392b" opacity="0.8"/><rect x="18" y="10" width="3" height="4" fill="#3498db" opacity="0.5" rx="0.2"/><path d="M18.5 11H19.5" stroke="#2980b9" stroke-width="0.7" stroke-linecap="round"/><path d="M18.5 13H19.5" stroke="#2980b9" stroke-width="0.7" stroke-linecap="round"/><path d="M2 17H15L16 14H18L19 17H21V18H19.5C19.5 19.1046 18.6046 20 17.5 20C16.3954 20 15.5 19.1046 15.5 18H8.5C8.5 19.1046 7.60457 20 6.5 20C5.39543 20 4.5 19.1046 4.5 18H2V17Z" fill="#95a5a6" stroke="#7f8c8d" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/><circle cx="6.5" cy="18" r="2" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="1"/><circle cx="6.5" cy="18" r="1.2" fill="#e74c3c"/><circle cx="17.5" cy="18" r="2" fill="#ecf0f1" stroke="#bdc3c7" stroke-width="1"/><circle cx="17.5" cy="18" r="1.2" fill="#e74c3c"/><path d="M16 14L15 10H2" stroke="#7f8c8d" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/><rect x="19" y="14" width="2.5" height="2.5" fill="#7f8c8d" opacity="0.6" rx="0.2"/></svg>',
            retail: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 21H21" stroke="#9b59b6" stroke-width="2" stroke-linecap="round"/><path d="M5 21V7L12 3L19 7V21" stroke="#9b59b6" stroke-width="1.5"/><path d="M9 9V21" stroke="#9b59b6" stroke-width="1.5"/><path d="M15 9V21" stroke="#9b59b6" stroke-width="1.5"/><rect x="7" y="11" width="10" height="4" fill="#9b59b6" opacity="0.3"/></svg>',
            consumption: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="9" cy="7" r="4" fill="#e74c3c" stroke="#c0392b" stroke-width="1.5"/><circle cx="15" cy="7" r="4" fill="#e74c3c" stroke="#c0392b" stroke-width="1.5"/><path d="M3 21C3 17 5.68629 14 9 14C12.3137 14 15 17 15 21" stroke="#c0392b" stroke-width="1.5" stroke-linecap="round"/><path d="M15 21C15 17 17.6863 14 21 14" stroke="#c0392b" stroke-width="1.5" stroke-linecap="round"/></svg>',
            waste: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6H5H21" stroke="#16a085" stroke-width="2" stroke-linecap="round"/><path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#16a085" stroke-width="1.5" stroke-linecap="round"/><path d="M10 11V17" stroke="#16a085" stroke-width="1.5" stroke-linecap="round"/><path d="M14 11V17" stroke="#16a085" stroke-width="1.5" stroke-linecap="round"/></svg>',
            security: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="18" height="12" rx="2" fill="#2c3e50" stroke="#34495e" stroke-width="1.5"/><circle cx="12" cy="13" r="3" fill="#3498db" stroke="#2980b9" stroke-width="1.5"/><path d="M12 10V13L14 15" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M6 7V5C6 3.89543 6.89543 3 8 3H16C17.1046 3 18 3.89543 18 5V7" stroke="#34495e" stroke-width="1.5"/><circle cx="8" cy="19" r="1" fill="#e74c3c"/><circle cx="16" cy="19" r="1" fill="#27ae60"/></svg>',
            overview: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="7" height="7" rx="1" fill="#3498db" stroke="#2980b9" stroke-width="1.5"/><rect x="14" y="3" width="7" height="7" rx="1" fill="#27ae60" stroke="#1e8449" stroke-width="1.5"/><rect x="3" y="14" width="7" height="7" rx="1" fill="#e67e22" stroke="#d35400" stroke-width="1.5"/><rect x="14" y="14" width="7" height="7" rx="1" fill="#9b59b6" stroke="#8e44ad" stroke-width="1.5"/></svg>',
            farm: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#27ae60" stroke="#1e8449" stroke-width="1.5"/><path d="M2 17L12 22L22 17" stroke="#1e8449" stroke-width="1.5" stroke-linecap="round"/><path d="M2 12L12 17L22 12" stroke="#1e8449" stroke-width="1.5" stroke-linecap="round"/></svg>',
            yield: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#27ae60" stroke="#1e8449" stroke-width="1.5"/><circle cx="12" cy="7" r="2" fill="#1e8449"/></svg>',
            pest: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="9" cy="9" r="6" fill="#e74c3c" stroke="#c0392b" stroke-width="1.5"/><circle cx="9" cy="9" r="2" fill="white"/><path d="M15 15L21 21" stroke="#c0392b" stroke-width="2" stroke-linecap="round"/><path d="M6 6L3 3" stroke="#c0392b" stroke-width="1.5" stroke-linecap="round"/><path d="M12 6L11 3" stroke="#c0392b" stroke-width="1.5" stroke-linecap="round"/><path d="M6 12L3 11" stroke="#c0392b" stroke-width="1.5" stroke-linecap="round"/></svg>',
            machinery: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="8" width="18" height="10" rx="2" fill="#34495e" stroke="#2c3e50" stroke-width="1.5"/><circle cx="8" cy="18" r="2" fill="#2c3e50"/><circle cx="16" cy="18" r="2" fill="#2c3e50"/><path d="M8 13H16" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M10 10H14" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>',
            spoilage: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="8" fill="#3498db" stroke="#2980b9" stroke-width="1.5"/><path d="M8 12H16" stroke="white" stroke-width="2" stroke-linecap="round"/><circle cx="9" cy="9" r="1.5" fill="white"/><circle cx="15" cy="9" r="1.5" fill="white"/></svg>',
            temperature: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2V8M12 8C10.8954 8 10 8.89543 10 10C10 11.1046 10.8954 12 12 12C13.1046 12 14 11.1046 14 10C14 8.89543 13.1046 8 12 8Z" stroke="#e74c3c" stroke-width="1.5" stroke-linecap="round"/><path d="M12 12V20C12 21.1046 12.8954 22 14 22C15.1046 22 16 21.1046 16 20V10" stroke="#e74c3c" stroke-width="1.5" stroke-linecap="round"/></svg>',
            defects: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="8" stroke="#e67e22" stroke-width="1.5"/><path d="M12 8V12M12 16H12.01" stroke="#e67e22" stroke-width="2" stroke-linecap="round"/></svg>',
            delays: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="#34495e" stroke-width="1.5"/><path d="M12 6V12L16 14" stroke="#34495e" stroke-width="2" stroke-linecap="round"/></svg>',
            waste_icon: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 6H5H21" stroke="#95a5a6" stroke-width="2" stroke-linecap="round"/><path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="#95a5a6" stroke-width="1.5" stroke-linecap="round"/></svg>',
            fuel: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 18L5 6H19L21 18M3 18H21M3 18V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V18" stroke="#f39c12" stroke-width="1.5" stroke-linecap="round"/><path d="M8 10V14M12 10V14M16 10V14" stroke="#f39c12" stroke-width="1.5" stroke-linecap="round"/></svg>',
            distance: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2Z" stroke="#3498db" stroke-width="1.5"/><circle cx="12" cy="9" r="3" fill="#3498db"/></svg>',
            inventory: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="7" width="18" height="14" rx="2" fill="#9b59b6" stroke="#8e44ad" stroke-width="1.5"/><path d="M8 7V5C8 3.89543 8.89543 3 10 3H14C15.1046 3 16 3.89543 16 5V7" stroke="#8e44ad" stroke-width="1.5"/><path d="M8 12H16M8 16H16" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>',
            sales: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 3H5L7.68 14.39C7.77144 14.8504 8.02191 15.264 8.38755 15.5583C8.75318 15.8526 9.2107 16.009 9.68 16H19.4C19.8693 16.009 20.3268 15.8526 20.6925 15.5583C21.0581 15.264 21.3086 14.8504 21.4 14.39L23 8H6" stroke="#27ae60" stroke-width="1.5" stroke-linecap="round"/><circle cx="9" cy="20" r="1" fill="#27ae60"/><circle cx="20" cy="20" r="1" fill="#27ae60"/></svg>',
            household: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 12L5 10M5 10L12 3L19 10M5 10V20C5 20.5523 5.44772 21 6 21H9M19 10L21 12M19 10V20C19 20.5523 18.5523 21 18 21H15M9 21C9.55228 21 10 20.5523 10 20V16C10 15.4477 10.4477 15 11 15H13C13.5523 15 14 15.4477 14 16V20C14 20.5523 14.4477 21 15 21M9 21H15" stroke="#e74c3c" stroke-width="1.5" stroke-linecap="round"/></svg>',
            satisfaction: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#f39c12" stroke="#e67e22" stroke-width="1.5"/><circle cx="9" cy="9" r="1.5" fill="#2c3e50"/><circle cx="15" cy="9" r="1.5" fill="#2c3e50"/><path d="M8 14C8 14 9.5 16 12 16C14.5 16 16 14 16 14" stroke="#2c3e50" stroke-width="1.5" stroke-linecap="round"/></svg>',
            ai: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="8" fill="#667eea" stroke="#764ba2" stroke-width="1.5"/><path d="M9 12L11 14L15 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
            sparkle: '<svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L13.5 8.5L20 10L13.5 11.5L12 18L10.5 11.5L4 10L10.5 8.5L12 2Z" fill="#f39c12" stroke="#e67e22" stroke-width="1"/></svg>'
        };
        
        function getIcon(name, size = '') {
            // Return emoji for farm icon
            if (name === 'farm') {
                return 'ðŸŒ¾';
            }
            const sizeClass = size ? ` icon-svg-${size}` : '';
            return icons[name] ? icons[name].replace('class="icon-svg"', `class="icon-svg${sizeClass}"`) : '';
        }
        
        let currentFarm = 'all';
        const charts = {};
        
        // Load AI insights from backend
        async function loadAIInsights(section) {
            try {
                const response = await fetch(`/api/ai-insights/${currentFarm}/${section}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error loading AI insights:', error);
                return { insights: ['Unable to load AI insights'], recommendations: [] };
            }
        }

        function switchFarm(farmName, eventElement) {
            currentFarm = farmName;
            document.querySelectorAll('.farm-tab').forEach(tab => tab.classList.remove('active'));
            if (eventElement) {
                eventElement.classList.add('active');
            } else {
                // Find the tab by text content
                document.querySelectorAll('.farm-tab').forEach(tab => {
                    if (farmName === 'all' && tab.textContent.trim() === 'All Farms') {
                        tab.classList.add('active');
                    } else if (farmName === 'FarmA' && tab.textContent.trim() === 'Farm A') {
                        tab.classList.add('active');
                    } else if (farmName === 'FarmB' && tab.textContent.trim() === 'Farm B') {
                        tab.classList.add('active');
                    } else if (farmName === 'FarmC' && tab.textContent.trim() === 'Farm C') {
                        tab.classList.add('active');
                    } else if (farmName === 'FarmD' && tab.textContent.trim() === 'Farm D') {
                        tab.classList.add('active');
                    }
                });
            }
            
            // Get current active section
            const activeSection = document.querySelector('.section.active');
            const sectionId = activeSection ? activeSection.id : 'overview';
            
            // Show overview section and reload data based on filter
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
            
            // Set active sidebar item using data-section attribute for reliable matching
            const sidebarItem = document.querySelector(`.sidebar-item[data-section="${sectionId}"]`);
            if (sidebarItem) {
                sidebarItem.classList.add('active');
            }
            
            // Handle Overview AI Insights box visibility
            const overviewSuggestionBox = document.getElementById('overviewSuggestion');
            if (overviewSuggestionBox) {
                if (sectionId !== 'overview') {
                    // Hide for non-overview sections
                    overviewSuggestionBox.style.setProperty('display', 'none', 'important');
                    overviewSuggestionBox.innerHTML = '';
                }
                // For overview section, visibility will be handled in loadOverviewData/loadFarmData
            }
            
            // Remove any farm-specific AI analysis boxes when switching farms in Overview
            if (sectionId === 'overview') {
                const farmAnalysisBox = document.getElementById('overviewFarmAnalysis');
                if (farmAnalysisBox) {
                    farmAnalysisBox.remove();
                }
            }
            
            // Reload data for the current section with new farm filter
            if (sectionId === 'overview') {
                if (farmName === 'all') {
                    loadOverviewData();
                } else {
                    loadFarmData(farmName);
                }
            } else {
                // Reload the current section with the new farm selection
                showSection(sectionId);
            }
        }

        function showSection(sectionId, event) {
            // Remove active class from all sections and sidebar items
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
            
            // Toggle security-active class on body to prevent page scrolling
            if (sectionId === 'security') {
                document.body.classList.add('security-active');
            } else {
                document.body.classList.remove('security-active');
            }
            
            // Activate the selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Set active sidebar item using data-section attribute for reliable matching
            const sidebarItem = document.querySelector(`.sidebar-item[data-section="${sectionId}"]`);
            if (sidebarItem) {
                sidebarItem.classList.add('active');
            }

            // Handle Overview AI Insights box visibility
            const overviewSuggestionBox = document.getElementById('overviewSuggestion');
            if (overviewSuggestionBox) {
                if (sectionId !== 'overview') {
                    // Hide for non-overview sections
                    overviewSuggestionBox.style.setProperty('display', 'none', 'important');
                    overviewSuggestionBox.innerHTML = '';
                }
                // For overview section, visibility will be handled in loadOverviewData/loadFarmData
            }
            
            // Remove any farm-specific AI analysis boxes when switching away from overview
            if (sectionId !== 'overview') {
                const farmAnalysisBox = document.getElementById('overviewFarmAnalysis');
                if (farmAnalysisBox) {
                    farmAnalysisBox.remove();
                }
            }

            // Load appropriate data based on current farm selection
            if (currentFarm === 'all') {
                if (sectionId === 'overview') {
                    loadOverviewData();
                } else if (sectionId === 'production') {
                    loadComparisonProduction();
                } else if (sectionId === 'storage') {
                    loadComparisonStorage();
                } else if (sectionId === 'processing') {
                    loadComparisonProcessing();
                } else if (sectionId === 'transportation') {
                    loadComparisonTransportation();
                } else if (sectionId === 'retail') {
                    loadComparisonRetail();
                } else if (sectionId === 'consumption') {
                    loadComparisonConsumption();
                } else if (sectionId === 'waste') {
                    loadComparisonWaste();
                } else if (sectionId === 'security') {
                    // Security section doesn't need farm data loading
                    initializeSecuritySection();
                }
            } else {
                if (sectionId === 'overview') {
                    loadFarmData(currentFarm);
                } else if (sectionId === 'production') {
                    loadProductionData();
                } else if (sectionId === 'storage') {
                    loadStorageData();
                } else if (sectionId === 'processing') {
                    loadProcessingData();
                } else if (sectionId === 'transportation') {
                    loadTransportationData();
                } else if (sectionId === 'retail') {
                    loadRetailData();
                } else if (sectionId === 'consumption') {
                    loadConsumptionData();
                } else if (sectionId === 'waste') {
                    loadWasteData();
                } else if (sectionId === 'security') {
                    // Security section doesn't need farm data loading
                    initializeSecuritySection();
                }
            }
        }

        // ESPCam stream management
        let espcamStreamInterval = null;
        let isESPCamConnected = false;
        let isConnecting = false;

        function updateConnectionButtons() {
            const connectBtn = document.getElementById('espcam-connect-btn');
            const disconnectBtn = document.getElementById('espcam-disconnect-btn');
            
            if (connectBtn && disconnectBtn) {
                if (isESPCamConnected) {
                    // Connected state - green button, disabled
                    connectBtn.disabled = true;
                    connectBtn.style.background = '#27ae60';
                    connectBtn.style.opacity = '1';
                    connectBtn.style.cursor = 'not-allowed';
                    connectBtn.style.pointerEvents = 'none';
                    connectBtn.textContent = 'Connected';
                    disconnectBtn.disabled = false;
                    disconnectBtn.style.opacity = '1';
                    disconnectBtn.style.cursor = 'pointer';
                    disconnectBtn.style.pointerEvents = 'auto';
                } else if (isConnecting) {
                    // Connecting state - disabled, showing connecting
                    connectBtn.disabled = true;
                    connectBtn.style.background = '#1a5f7a';
                    connectBtn.style.opacity = '0.7';
                    connectBtn.style.cursor = 'not-allowed';
                    connectBtn.style.pointerEvents = 'none';
                    connectBtn.textContent = 'Connecting...';
                    disconnectBtn.disabled = false;
                    disconnectBtn.style.opacity = '1';
                    disconnectBtn.style.cursor = 'pointer';
                    disconnectBtn.style.pointerEvents = 'auto';
                } else {
                    // Disconnected state - enable connect button
                    connectBtn.disabled = false;
                    connectBtn.style.background = '#1a5f7a';
                    connectBtn.style.opacity = '1';
                    connectBtn.style.cursor = 'pointer';
                    connectBtn.style.pointerEvents = 'auto';
                    connectBtn.textContent = 'Connect';
                    disconnectBtn.disabled = true;
                    disconnectBtn.style.opacity = '0.6';
                    disconnectBtn.style.cursor = 'not-allowed';
                    disconnectBtn.style.pointerEvents = 'none';
                }
            }
        }

        // Notification system
        let notifications = [];
        
        function formatTimestamp(date) {
            const now = new Date(date);
            const dateStr = now.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true 
            });
            return `${dateStr} ${timeStr}`;
        }
        
        function addNotification(type, message) {
            const notification = {
                id: Date.now(),
                type: type, // 'motion', 'infrared', 'system'
                message: message,
                timestamp: new Date()
            };
            
            notifications.unshift(notification); // Add to beginning
            
            // Keep only last 50 notifications
            if (notifications.length > 50) {
                notifications = notifications.slice(0, 50);
            }
            
            renderNotifications();
        }
        
        function renderNotifications() {
            const listContainer = document.getElementById('notifications-list');
            if (!listContainer) return;
            
            // Filter to show only motion alerts
            const motionNotifications = notifications.filter(n => n.type === 'motion');
            
            if (motionNotifications.length === 0) {
                listContainer.innerHTML = `
                    <div class="notification-empty">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 48px; height: 48px; margin: 0 auto 10px; opacity: 0.3;">
                            <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" fill="#95a5a6"/>
                        </svg>
                        <p>No motion alerts yet</p>
                        <p style="font-size: 12px;">Motion alerts will appear here when detected</p>
                    </div>
                `;
                return;
            }
            
            listContainer.innerHTML = motionNotifications.map(notif => {
                return `
                    <div class="notification-item motion" onclick="removeNotification(${notif.id})">
                        <div class="notification-header">
                            <span class="notification-type">Motion Detected</span>
                            <span class="notification-time">${formatTimestamp(notif.timestamp)}</span>
                        </div>
                        <div class="notification-message">${notif.message}</div>
                    </div>
                `;
            }).join('');
        }
        
        function removeNotification(id) {
            notifications = notifications.filter(n => n.id !== id);
            renderNotifications();
        }
        
        function loadDemoNotifications() {
            // Clear existing notifications
            notifications = [];
            
            // Generate demo notifications - only motion alerts
            const now = new Date();
            const demoData = [
                {
                    type: 'motion',
                    message: 'Motion detected in camera view area',
                    minutesAgo: 2
                },
                {
                    type: 'motion',
                    message: 'Movement detected near entrance',
                    minutesAgo: 15
                },
                {
                    type: 'motion',
                    message: 'Motion detected in storage area',
                    minutesAgo: 32
                },
                {
                    type: 'motion',
                    message: 'Activity detected in parking lot',
                    minutesAgo: 45
                },
                {
                    type: 'motion',
                    message: 'Motion detected near warehouse',
                    minutesAgo: 67
                },
                {
                    type: 'motion',
                    message: 'Movement detected in loading area',
                    minutesAgo: 89
                },
                {
                    type: 'motion',
                    message: 'Motion detected at main gate',
                    minutesAgo: 120
                }
            ];
            
            demoData.forEach(item => {
                const timestamp = new Date(now.getTime() - item.minutesAgo * 60000);
                const notification = {
                    id: timestamp.getTime(),
                    type: item.type,
                    message: item.message,
                    timestamp: timestamp
                };
                notifications.push(notification);
            });
            
            // Sort by timestamp (newest first)
            notifications.sort((a, b) => b.timestamp - a.timestamp);
            
            renderNotifications();
        }
        
        // Function to be called by sensors in the future
        function triggerSecurityAlert(type, message) {
            addNotification(type, message);
        }

        function initializeSecuritySection() {
            // Load saved ESPCam configuration from localStorage if available
            const savedIP = localStorage.getItem('espcam_ip');
            const savedPort = localStorage.getItem('espcam_port');
            if (savedIP) {
                document.getElementById('espcam-ip').value = savedIP;
            }
            if (savedPort) {
                document.getElementById('espcam-port').value = savedPort;
            }
            // Update button states on initialization
            updateConnectionButtons();
            // Load demo notifications
            loadDemoNotifications();
        }

        function connectESPCam() {
            // Check if already connected or connecting
            if (isESPCamConnected) {
                return; // Already connected, do nothing
            }
            
            if (isConnecting) {
                return; // Connection in progress, do nothing
            }

            const ip = document.getElementById('espcam-ip').value.trim();
            const port = document.getElementById('espcam-port').value.trim() || '81';
            const statusDiv = document.getElementById('espcam-status');
            const streamIframe = document.getElementById('espcam-stream');
            const streamImg = document.getElementById('espcam-stream-img');

            if (!ip) {
                alert('Please enter ESP32 camera IP address');
                return;
            }

            // Validate IP address format (basic validation)
            const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipPattern.test(ip)) {
                alert('Please enter a valid IP address');
                return;
            }

            // Set connecting state and update buttons
            isConnecting = true;
            updateConnectionButtons();

            // Save configuration to localStorage
            localStorage.setItem('espcam_ip', ip);
            localStorage.setItem('espcam_port', port);

            // Hide status and show loading
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <p style="font-size: 18px; margin-bottom: 10px;">ðŸ”„ Connecting...</p>
                <p style="font-size: 14px; color: #95a5a6;">Attempting to connect to ${ip}:${port}</p>
            `;
            streamIframe.style.display = 'none';
            streamImg.style.display = 'none';

            // Common ESP32-CAM endpoints - prioritize img endpoints for better scaling
            const endpoints = [
                { url: `http://${ip}:${port}/stream`, type: 'img' },  // Try as img first
                { url: `http://${ip}:${port}/cam.mjpeg`, type: 'img' },  // Try as img first
                { url: `http://${ip}:${port}/mjpeg/stream`, type: 'img' },  // Try as img first
                { url: `http://${ip}:${port}/capture`, type: 'img' },
                { url: `http://${ip}:${port}/video`, type: 'img' },
                { url: `http://${ip}:${port}/`, type: 'iframe' },  // Fallback to iframe
                { url: `http://${ip}:${port}/stream`, type: 'iframe' },  // Fallback to iframe
                { url: `http://${ip}:${port}/cam.mjpeg`, type: 'iframe' }  // Fallback to iframe
            ];

            let currentEndpointIndex = 0;
            let attemptCount = 0;
            const maxAttempts = endpoints.length;

            const tryConnect = () => {
                if (currentEndpointIndex >= endpoints.length) {
                    // All endpoints failed
                    streamIframe.style.display = 'none';
                    streamImg.style.display = 'none';
                    statusDiv.style.display = 'block';
                    statusDiv.innerHTML = `
                        <p style="font-size: 18px; margin-bottom: 10px;">âŒ Connection Failed</p>
                        <p style="font-size: 14px; color: #e74c3c;">Unable to connect to ESP32 camera at ${ip}:${port}</p>
                        <p style="font-size: 12px; color: #95a5a6; margin-top: 10px;">Please check:</p>
                        <ul style="font-size: 12px; color: #95a5a6; text-align: left; display: inline-block; margin-top: 5px;">
                            <li>Camera is powered on and connected to network</li>
                            <li>IP address and port are correct</li>
                            <li>Camera firmware supports streaming</li>
                            <li>No firewall blocking the connection</li>
                            <li>Try accessing the camera directly in a browser first</li>
                        </ul>
                    `;
                    isESPCamConnected = false;
                    isConnecting = false;
                    updateConnectionButtons();
                    return;
                }

                const endpoint = endpoints[currentEndpointIndex];
                attemptCount++;

                if (endpoint.type === 'iframe') {
                    // Try iframe for MJPEG streams (fallback)
                    streamIframe.src = endpoint.url;
                    streamIframe.style.display = 'block';
                    streamImg.style.display = 'none';
                    
                    let endpointTried = false;
                    let timeoutId;
                    
                    // Set up timeout to try next endpoint if this one doesn't work after 4 seconds
                    timeoutId = setTimeout(() => {
                        if (!isESPCamConnected && !endpointTried && isConnecting) {
                            endpointTried = true;
                            streamIframe.style.display = 'none';
                            currentEndpointIndex++;
                            tryConnect();
                        }
                    }, 4000);
                    
                    // If iframe loads successfully, hide status and mark as connected
                    streamIframe.onload = function() {
                        if (!endpointTried) {
                            clearTimeout(timeoutId);
                            endpointTried = true;
                            statusDiv.style.display = 'none';
                            isESPCamConnected = true;
                            isConnecting = false;
                            streamIframe.style.display = 'block';
                            updateConnectionButtons();
                        }
                    };
                    
                    // For MJPEG streams, iframe.onload may not fire reliably
                    setTimeout(() => {
                        if (!endpointTried && !isESPCamConnected && isConnecting) {
                            statusDiv.style.display = 'none';
                            isESPCamConnected = true;
                            isConnecting = false;
                            streamIframe.style.display = 'block';
                            updateConnectionButtons();
                        }
                    }, 2500);
                } else {
                    // Try img tag for MJPEG/JPEG streams (preferred for better scaling)
                    const streamUrl = endpoint.url + (endpoint.url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                    streamImg.src = streamUrl;
                    // Let CSS handle the card styling - just set display
                    streamImg.style.display = 'block';
                    streamIframe.style.display = 'none';
                    
                    streamImg.onload = function() {
                        statusDiv.style.display = 'none';
                        isESPCamConnected = true;
                        isConnecting = false;
                        streamImg.style.display = 'block';
                        updateConnectionButtons();
                        
                        // For MJPEG/JPEG streams, refresh periodically for smooth video
                        if (espcamStreamInterval) {
                            clearInterval(espcamStreamInterval);
                        }
                        // Refresh for smooth video-like experience
                        espcamStreamInterval = setInterval(() => {
                            if (isESPCamConnected) {
                                streamImg.src = endpoint.url + (endpoint.url.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                            }
                        }, 50); // Refresh every 50ms for smoother video-like experience
                    };
                    
                    streamImg.onerror = function() {
                        currentEndpointIndex++;
                        tryConnect();
                    };
                }
            };

            tryConnect();
        }

        function disconnectESPCam() {
            const statusDiv = document.getElementById('espcam-status');
            const streamIframe = document.getElementById('espcam-stream');
            const streamImg = document.getElementById('espcam-stream-img');
            
            streamIframe.src = '';
            streamImg.src = '';
            streamIframe.style.display = 'none';
            streamImg.style.display = 'none';
            streamIframe.removeAttribute('style');
            streamImg.removeAttribute('style');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <p style="font-size: 24px; margin-bottom: 12px;">ðŸ“¹ Camera Feed</p>
                <p style="font-size: 16px; color: #7f8c8d;">Configure and connect to view live feed</p>
            `;
            isESPCamConnected = false;
            isConnecting = false;

            if (espcamStreamInterval) {
                clearInterval(espcamStreamInterval);
                espcamStreamInterval = null;
            }
            
            // Update button states after disconnecting
            updateConnectionButtons();
        }

        function getSectionEmoji(sectionId) {
            const emojis = {
                'overview': 'ðŸ“Š',
                'production': 'ðŸŒ±',
                'storage': 'â„ï¸',
                'processing': 'âš™ï¸',
                'transportation': 'ðŸšš',
                'retail': 'ðŸª',
                'consumption': 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦',
                'waste': 'â™»ï¸',
                'security': 'ðŸ”’'
            };
            return emojis[sectionId] || '';
        }

        function createKPICard(label, value, unit, type = '', aiTip = '') {
            const typeClass = type ? ` ${type}` : '';
            // Truncate AI tip to one line if too long
            const shortTip = aiTip && aiTip.length > 60 ? aiTip.substring(0, 57) + '...' : aiTip;
            return `<div class="kpi-card${typeClass}"><div class="kpi-label">âœ¨ ${label}</div><div class="kpi-value">${parseFloat(value).toFixed(2)}</div><div class="kpi-unit">${unit}</div>${shortTip ? `<div class="ai-insight">ðŸ’¡ ${shortTip}</div>` : ''}</div>`;
        }

        function createAISuggestion(title, insightsArray, recommendationsArray = [], sideBySide = false) {
            let insightsContent = '';
            let recommendationsContent = '';
            
            // Format insights as separate items
            if (Array.isArray(insightsArray) && insightsArray.length > 0) {
                insightsContent = insightsArray.map(insight => `<div class="ai-insight-item">${insight}</div>`).join('');
            } else if (typeof insightsArray === 'string') {
                // Handle string format (backward compatibility)
                if (insightsArray.includes('<br>')) {
                    insightsContent = `<p>${insightsArray}</p>`;
                } else {
                    const items = insightsArray.split(' | ').filter(item => item.trim());
                    insightsContent = items.map(item => `<div class="ai-insight-item">${item.trim()}</div>`).join('');
                }
            }
            
            // Format recommendations
            if (Array.isArray(recommendationsArray) && recommendationsArray.length > 0) {
                recommendationsContent = recommendationsArray.map(rec => `<div class="ai-insight-item" style="margin-left: 8px;">â€¢ ${rec}</div>`).join('');
            }
            
            const aiIcon = getIcon('ai', 'lg');
            const sideBySideClass = sideBySide ? ' side-by-side' : '';
            
            if (sideBySide && recommendationsContent) {
                // Side-by-side layout for comparison views
                return `<div class="icon">${aiIcon}</div><div class="content"><h4>${title}</h4><div class="sections-grid"><div class="insights-section"><h5>Insights:</h5><div>${insightsContent}</div></div><div class="recommendations-section"><h5>Recommendations:</h5><div>${recommendationsContent}</div></div></div></div>`;
            } else {
                // Stacked layout for farm-specific views
                let content = insightsContent;
                if (recommendationsContent) {
                    content += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2);"><strong>Recommendations:</strong><br>';
                    content += recommendationsContent;
                    content += '</div>';
                }
                return `<div class="icon">${aiIcon}</div><div class="content"><h4>${title}</h4><div>${content}</div></div>`;
            }
        }

        function getPerformanceClass(score) {
            if (score >= 80) return 'excellent';
            if (score >= 65) return 'good';
            if (score >= 50) return 'average';
            return 'poor';
        }

        function getStatusText(score) {
            if (score >= 80) return 'Excellent Performance';
            if (score >= 65) return 'Good Performance';
            if (score >= 50) return 'Average Performance';
            return 'Needs Attention';
        }

        function loadOverviewData() {
            // Only show AI Insights in Overview when viewing "All Farms"
            if (currentFarm !== 'all') {
                const mainAIBox = document.getElementById('overviewSuggestion');
                if (mainAIBox) {
                    mainAIBox.style.display = 'none';
                }
                return;
            }
            
            fetch('/api/overview').then(r => r.json()).then(data => {
                const farms = Object.keys(data);
                let html = '';
                
                const farmIcon = getIcon('farm', 'lg');
                const yieldIcon = getIcon('yield', 'sm');
                const spoilageIcon = getIcon('spoilage', 'sm');
                const defectsIcon = getIcon('defects', 'sm');
                const transportationIcon = getIcon('transportation', 'sm');
                const wasteIcon = getIcon('waste_icon', 'sm');
                const satisfactionIcon = getIcon('satisfaction', 'sm');
                
                farms.forEach(farm => {
                    const farmData = data[farm];
                    const perfClass = getPerformanceClass(farmData.performance_score);
                    const statusClass = getPerformanceClass(farmData.performance_score);
                    
                    html += `
                        <div class="farm-card ${perfClass}">
                            <div class="farm-card-header">
                                <h3>${farmIcon} ${farm}</h3>
                                <div class="performance-score-container">
                                    <span class="performance-score">${farmData.performance_score.toFixed(0)}</span>
                                    <span class="performance-score-label">/100</span>
                                </div>
                                <span class="status-badge ${statusClass}">${getStatusText(farmData.performance_score)}</span>
                            </div>
                            <div class="farm-card-body">
                                <div class="metric-row">
                                    <span class="metric-label">${yieldIcon} Yield</span>
                                    <span class="metric-value">${farmData.yield.toFixed(2)} tonnes/ha</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${spoilageIcon} Spoilage</span>
                                    <span class="metric-value">${farmData.spoilage.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${defectsIcon} Defects</span>
                                    <span class="metric-value">${farmData.defects.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${transportationIcon} Delays</span>
                                    <span class="metric-value">${farmData.delays.toFixed(1)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${wasteIcon} Waste</span>
                                    <span class="metric-value">${farmData.waste.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${satisfactionIcon} Satisfaction</span>
                                    <span class="metric-value">${farmData.satisfaction.toFixed(1)}/10</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                const container = document.getElementById('farm-comparison-container');
                container.className = 'farm-comparison';
                container.innerHTML = html;
                
                // Show comparison charts when viewing all farms
                document.querySelectorAll('#overviewChart1, #overviewChart2, #overviewChart3, #overviewChart4').forEach(chart => {
                    chart.closest('.chart-container').style.display = 'block';
                });
                
                // Remove any inline AI boxes that might be leftover from farm-specific views
                const inlineBox = document.getElementById('overviewSuggestionInline');
                if (inlineBox) {
                    inlineBox.remove();
                }
                
                // Remove any farm-specific AI analysis boxes from individual farm views
                const farmAnalysisBox = document.getElementById('overviewFarmAnalysis');
                if (farmAnalysisBox) {
                    farmAnalysisBox.remove();
                }
                
                // Show the main AI suggestion box ONLY when viewing all farms in Overview section
                const mainAIBox = document.getElementById('overviewSuggestion');
                if (mainAIBox) {
                    if (currentFarm === 'all') {
                        // Force show the box using setProperty with important flag to override CSS
                        mainAIBox.style.setProperty('display', 'flex', 'important');
                        mainAIBox.innerHTML = ''; // Clear any previous content
                        
                        // Load smart AI insights
                        loadAIInsights('overview').then(aiData => {
                            const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All metrics within optimal range'];
                            const recommendations = aiData.recommendations || [];
                            mainAIBox.innerHTML = createAISuggestion('AI Insights', insights, recommendations);
                        }).catch(err => {
                            console.error('Error loading AI insights:', err);
                            mainAIBox.innerHTML = createAISuggestion('AI Insights', ['All metrics within optimal range'], []);
                        });
                    } else {
                        // Hide for individual farms
                        mainAIBox.style.setProperty('display', 'none', 'important');
                        mainAIBox.innerHTML = '';
                    }
                }
                
                loadOverviewCharts(data);
            }).catch(err => {
                console.error('Error loading overview:', err);
                document.getElementById('farm-comparison-container').innerHTML = '<p>Error loading farm data. Please ensure all farm CSV files are present.</p>';
            });
        }

        function loadOverviewCharts(data) {
            const farms = Object.keys(data);
            
            // Yield Comparison
                const ctx1 = document.getElementById('overviewChart1').getContext('2d');
                if (charts.overviewChart1) charts.overviewChart1.destroy();
                charts.overviewChart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                    labels: farms,
                    datasets: [{
                        label: 'Average Yield (tonnes/ha)',
                        data: farms.map(f => data[f].yield),
                        backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12']
                    }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
            });

            // Spoilage Comparison
                const ctx2 = document.getElementById('overviewChart2').getContext('2d');
                if (charts.overviewChart2) charts.overviewChart2.destroy();
                charts.overviewChart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                    labels: farms,
                    datasets: [{
                        label: 'Spoilage Rate (%)',
                        data: farms.map(f => data[f].spoilage),
                        backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12']
                    }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
            });

            // Performance Score
                const ctx3 = document.getElementById('overviewChart3').getContext('2d');
                if (charts.overviewChart3) charts.overviewChart3.destroy();
                charts.overviewChart3 = new Chart(ctx3, {
                type: 'bar',
                    data: {
                    labels: farms,
                    datasets: [{
                        label: 'Performance Score',
                        data: farms.map(f => data[f].performance_score),
                        backgroundColor: farms.map(f => {
                            const score = data[f].performance_score;
                            if (score >= 80) return '#27ae60';
                            if (score >= 65) return '#3498db';
                            if (score >= 50) return '#f39c12';
                            return '#e74c3c';
                        })
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
            });
            
            // Defect Rate Comparison
            const ctx4 = document.getElementById('overviewChart4').getContext('2d');
            if (charts.overviewChart4) charts.overviewChart4.destroy();
            charts.overviewChart4 = new Chart(ctx4, {
                type: 'bar',
                    data: {
                    labels: farms,
                    datasets: [{
                        label: 'Defect Rate (%)',
                        data: farms.map(f => data[f].defects),
                        backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12']
                    }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
        }

        function loadFarmData(farmName) {
            currentFarm = farmName;
            // Load KPIs for the selected farm and show in overview section
            Promise.all([
                fetch(`/api/farm/${currentFarm}/kpis`).then(r => r.json()),
                loadAIInsights('overview')
            ]).then(([data, aiData]) => {
                const score = calculatePerformanceScore(data);
                const perfClass = getPerformanceClass(score);
                
                // Update the overview section to show farm-specific data with AI Analysis
                const container = document.getElementById('farm-comparison-container');
                container.className = 'overview-single-farm-container';
                
                // Hide the main AI suggestion box when viewing single farm (force hide)
                const mainAIBox = document.getElementById('overviewSuggestion');
                if (mainAIBox) {
                    mainAIBox.style.setProperty('display', 'none', 'important');
                    mainAIBox.innerHTML = ''; // Clear content to prevent any visibility
                }
                
                const farmIcon = getIcon('farm', 'lg');
                const yieldIcon = getIcon('yield', 'sm');
                const spoilageIcon = getIcon('spoilage', 'sm');
                const defectsIcon = getIcon('defects', 'sm');
                const transportationIcon = getIcon('transportation', 'sm');
                const wasteIcon = getIcon('waste_icon', 'sm');
                const satisfactionIcon = getIcon('satisfaction', 'sm');
                const pestIcon = getIcon('pest', 'sm');
                const machineryIcon = getIcon('machinery', 'sm');
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All metrics within optimal range'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Analysis', insights, recommendations);
                
                // Create side-by-side layout: Farm card and AI Analysis box
                container.innerHTML = `
                    <div class="farm-stage-container">
                        <div class="farm-stage-cards">
                            <div class="farm-card ${perfClass}">
                                <div class="farm-card-header">
                                    <h3>${farmIcon} ${farmName}</h3>
                                    <div class="performance-score-container">
                                        <span class="performance-score">${score.toFixed(0)}</span>
                                        <span class="performance-score-label">/100</span>
                                    </div>
                                    <span class="status-badge ${perfClass}">${getStatusText(score)}</span>
                                </div>
                                <div class="farm-card-body">
                                    <div class="metric-row">
                                        <span class="metric-label">${yieldIcon} Yield</span>
                                        <span class="metric-value">${data.total_production.toFixed(2)} tonnes/ha</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${spoilageIcon} Spoilage</span>
                                        <span class="metric-value">${data.storage_spoilage.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${defectsIcon} Defects</span>
                                        <span class="metric-value">${data.processing_defects.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${transportationIcon} Delays</span>
                                        <span class="metric-value">${data.transport_delays.toFixed(1)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${wasteIcon} Waste</span>
                                        <span class="metric-value">${data.waste_percentage.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${satisfactionIcon} Satisfaction</span>
                                        <span class="metric-value">${data.satisfaction.toFixed(1)}/10</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${pestIcon} Pest Risk</span>
                                        <span class="metric-value">${data.pest_risk.toFixed(1)}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${machineryIcon} Machinery Uptime</span>
                                        <span class="metric-value">${data.machinery_uptime.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-suggestion-box" id="overviewFarmAnalysis">${aiSuggestionHTML}</div>
                        </div>
                    </div>
                `;
                
                // Hide comparison charts when viewing single farm
                document.querySelectorAll('#overviewChart1, #overviewChart2, #overviewChart3, #overviewChart4').forEach(chart => {
                    chart.closest('.chart-container').style.display = 'none';
                });
            }).catch(err => {
                console.error('Error loading farm data:', err);
                document.getElementById('farm-comparison-container').innerHTML = '<p>Error loading farm data. Please ensure the farm CSV file exists.</p>';
            });
        }

        function calculatePerformanceScore(data) {
            const score = (
                (data.total_production / 10 * 20) +
                ((1 - data.storage_spoilage / 30) * 15) +
                ((1 - data.processing_defects / 15) * 15) +
                ((1 - data.transport_delays / 30) * 10) +
                ((1 - data.waste_percentage / 25) * 10) +
                (data.satisfaction / 10 * 15) +
                ((1 - data.pest_risk / 100) * 10) +
                (data.machinery_uptime / 100 * 5)
            );
            return Math.min(100, Math.max(0, score));
        }

        async function loadComparisonProduction() {
            try {
                const [comparisonData, aiData] = await Promise.all([
                    fetch('/api/comparison/production').then(r => {
                        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                        return r.json();
                    }),
                    loadAIInsights('production').catch(() => ({ insights: [], recommendations: [], farm_insights: {} }))
                ]);

                const farms = Object.keys(comparisonData);
                let html = '';
                const farmIcon = getIcon('farm', 'lg');
                const yieldIcon = getIcon('yield', 'sm');
                const pestIcon = getIcon('pest', 'sm');
                const machineryIcon = getIcon('machinery', 'sm');
                
                farms.forEach(farm => {
                    const data = comparisonData[farm];
                    if (!data) {
                        console.error(`No data for farm: ${farm}`);
                        return;
                    }
                    const yield_val = data.yield || 0;
                    const pest_risk = data.pest_risk || 0;
                    const harvest_uptime = data.harvest_uptime || 0;
                    const machinery_uptime = data.machinery_uptime || 0;
                    const perfScore = yield_val > 7 && pest_risk < 50 ? 80 : yield_val > 5 && pest_risk < 70 ? 65 : 50;
                    const perfClass = getPerformanceClass(perfScore);
                    const farmInsight = aiData.farm_insights && aiData.farm_insights[farm] ? aiData.farm_insights[farm] : '';
                    html += `
                        <div class="farm-card ${perfClass}">
                            <div class="farm-card-header">
                                <h3>${farmIcon} ${farm}</h3>
                                <div class="performance-score-container">
                                    <span class="performance-score">${perfScore.toFixed(0)}</span>
                                    <span class="performance-score-label">/100</span>
                                </div>
                                <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                            </div>
                            <div class="farm-card-body">
                                <div class="metric-row">
                                    <span class="metric-label">${yieldIcon} Yield</span>
                                    <span class="metric-value">${yield_val.toFixed(2)} tonnes/ha</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${pestIcon} Pest Risk</span>
                                    <span class="metric-value">${pest_risk.toFixed(2)}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${machineryIcon} Harvest Uptime</span>
                                    <span class="metric-value">${harvest_uptime.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${machineryIcon} Machinery Uptime</span>
                                    <span class="metric-value">${machinery_uptime.toFixed(2)}%</span>
                                </div>
                                ${farmInsight ? `<div class="ai-insight">ðŸ’¡ ${farmInsight}</div>` : ''}
                            </div>
                        </div>
                `;
            });
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All farms performing well'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Comparison', insights, recommendations, true);
                
                document.getElementById('production-container').innerHTML = `
                    <div class="farm-comparison">
                        ${html}
                    </div>
                    <div class="ai-suggestion-box side-by-side" id="productionSuggestion">${aiSuggestionHTML}</div>
                `;
                
                // Create comparison chart
                const ctx = document.getElementById('productionChart1').getContext('2d');
                if (charts.productionChart1) charts.productionChart1.destroy();
                const allCrops = new Set();
                farms.forEach(farm => {
                    if (comparisonData[farm] && comparisonData[farm].yield_by_crop) {
                        Object.keys(comparisonData[farm].yield_by_crop).forEach(crop => allCrops.add(crop));
                    }
                });
                const cropLabels = Array.from(allCrops);
                
                charts.productionChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: cropLabels,
                        datasets: farms.map((farm, idx) => ({
                            label: farm,
                            data: cropLabels.map(crop => (comparisonData[farm] && comparisonData[farm].yield_by_crop && comparisonData[farm].yield_by_crop[crop]) || 0),
                            backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12'][idx]
                        }))
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading comparison data:', err);
                document.getElementById('production-container').innerHTML = `<p style="color: red; padding: 20px;">Error loading data: ${err.message}. Please check the console for details.</p>`;
            }
        }

        async function loadProductionData() {
            if (currentFarm === 'all') {
                loadComparisonProduction();
                return;
            }
            
            try {
                const [kpisData, productionData, aiData] = await Promise.all([
                    fetch(`/api/farm/${currentFarm}/kpis`).then(r => r.json()),
                    fetch(`/api/farm/${currentFarm}/production`).then(r => r.json()),
                    loadAIInsights('production')
                ]);

                const score = calculatePerformanceScore(kpisData);
                const perfClass = getPerformanceClass(score);
                const farmIcon = getIcon('farm', 'lg');
                const yieldIcon = getIcon('yield', 'sm');
                const pestIcon = getIcon('pest', 'sm');
                const machineryIcon = getIcon('machinery', 'sm');

                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All metrics optimal'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Analysis', insights, recommendations);

                // Create side-by-side layout: Farm card and AI box
                document.getElementById('production-container').innerHTML = `
                    <div class="farm-stage-container">
                        <div class="farm-stage-cards">
                            <div class="farm-card ${perfClass}">
                                <div class="farm-card-header">
                                    <h3>${farmIcon} ${currentFarm}</h3>
                                    <div class="performance-score-container">
                                        <span class="performance-score">${score.toFixed(0)}</span>
                                        <span class="performance-score-label">/100</span>
                                    </div>
                                    <span class="status-badge ${perfClass}">${getStatusText(score)}</span>
                                </div>
                                <div class="farm-card-body">
                                    <div class="metric-row">
                                        <span class="metric-label">${yieldIcon} Yield</span>
                                        <span class="metric-value">${kpisData.total_production.toFixed(2)} tonnes/ha</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${pestIcon} Pest Risk</span>
                                        <span class="metric-value">${kpisData.pest_risk.toFixed(2)}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${yieldIcon} Harvest Uptime</span>
                                        <span class="metric-value">${kpisData.harvest_uptime.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${machineryIcon} Machinery Uptime</span>
                                        <span class="metric-value">${kpisData.machinery_uptime.toFixed(2)}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-suggestion-box" id="productionSuggestion">${aiSuggestionHTML}</div>
                        </div>
                    </div>
                `;
                
                const ctx = document.getElementById('productionChart1').getContext('2d');
                if (charts.productionChart1) charts.productionChart1.destroy();
                charts.productionChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(productionData.yield_by_crop),
                        datasets: [{
                            label: 'Average Yield (tonnes/ha)',
                            data: Object.values(productionData.yield_by_crop),
                            backgroundColor: '#27ae60'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading production data:', err);
                document.getElementById('production-container').innerHTML = '<p>Error loading data. Please ensure the farm CSV file exists.</p>';
            }
        }

        async function loadComparisonStorage() {
            try {
                const [comparisonData, aiData] = await Promise.all([
                    fetch('/api/comparison/storage').then(r => {
                        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                        return r.json();
                    }),
                    loadAIInsights('storage').catch(() => ({ insights: [], recommendations: [], farm_insights: {} }))
                ]);

                const farms = Object.keys(comparisonData);
                let html = '';
                
                farms.forEach(farm => {
                    const data = comparisonData[farm];
                    if (!data) {
                        console.error(`No data for farm: ${farm}`);
                        return;
                    }
                    const avg_temp = data.avg_temp || 0;
                    const avg_humidity = data.avg_humidity || 0;
                    const avg_spoilage = data.avg_spoilage || 0;
                    const avg_shelf_life = data.avg_shelf_life || 0;
                    const perfScore = avg_spoilage < 10 ? 80 : avg_spoilage < 15 ? 65 : 50;
                    const perfClass = getPerformanceClass(perfScore);
                    const farmIcon = getIcon('farm', 'lg');
                    const tempIcon = getIcon('temperature', 'sm');
                    const spoilageIcon = getIcon('spoilage', 'sm');
                    const humidityIcon = getIcon('temperature', 'sm'); // Using temperature icon for humidity
                    const shelfLifeIcon = getIcon('processing', 'sm'); // Using processing icon for shelf life
                    
                    html += `
                        <div class="farm-card ${perfClass}">
                            <div class="farm-card-header">
                                <h3>${farmIcon} ${farm}</h3>
                                <div class="performance-score-container">
                                    <span class="performance-score">${perfScore.toFixed(0)}</span>
                                    <span class="performance-score-label">/100</span>
                                </div>
                                <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                            </div>
                            <div class="farm-card-body">
                                <div class="metric-row">
                                    <span class="metric-label">${tempIcon} Temperature</span>
                                    <span class="metric-value">${avg_temp.toFixed(2)}Â°C</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${humidityIcon} Humidity</span>
                                    <span class="metric-value">${avg_humidity.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${spoilageIcon} Spoilage</span>
                                    <span class="metric-value">${avg_spoilage.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${shelfLifeIcon} Shelf Life</span>
                                    <span class="metric-value">${avg_shelf_life.toFixed(1)} days</span>
                                </div>
                            </div>
                        </div>
                `;
            });
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All farms performing well'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Comparison', insights, recommendations, true);
                
                document.getElementById('storage-container').innerHTML = `
                    <div class="farm-comparison">
                        ${html}
                    </div>
                    <div class="ai-suggestion-box side-by-side" id="storageSuggestion">${aiSuggestionHTML}</div>
                `;
                
                // Comparison chart
                const ctx = document.getElementById('storageChart1').getContext('2d');
                if (charts.storageChart1) charts.storageChart1.destroy();
                charts.storageChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: farms,
                        datasets: [
                            { label: 'Temp (Â°C)', data: farms.map(f => comparisonData[f].avg_temp), backgroundColor: '#3498db' },
                            { label: 'Spoilage (%)', data: farms.map(f => comparisonData[f].avg_spoilage), backgroundColor: '#e74c3c' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading comparison data:', err);
                document.getElementById('storage-container').innerHTML = '<p>Error loading data.</p>';
            }
        }

        async function loadStorageData() {
            if (currentFarm === 'all') {
                loadComparisonStorage();
                return;
            }
            
            try {
                const [data, aiData] = await Promise.all([
                    fetch(`/api/farm/${currentFarm}/storage`).then(r => r.json()),
                    loadAIInsights('storage')
                ]);
                
                const perfScore = data.avg_spoilage < 10 ? 85 : data.avg_spoilage < 15 ? 70 : data.avg_spoilage < 20 ? 55 : 40;
                const perfClass = getPerformanceClass(perfScore);
                const farmIcon = getIcon('farm', 'lg');
                const tempIcon = getIcon('temperature', 'sm');
                const spoilageIcon = getIcon('spoilage', 'sm');
                const humidityIcon = getIcon('temperature', 'sm');
                const shelfLifeIcon = getIcon('processing', 'sm');
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All metrics optimal'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Analysis', insights, recommendations);
                
                // Create side-by-side layout: Farm card and AI box
                document.getElementById('storage-container').innerHTML = `
                    <div class="farm-stage-container">
                        <div class="farm-stage-cards">
                            <div class="farm-card ${perfClass}">
                                <div class="farm-card-header">
                                    <h3>${farmIcon} ${currentFarm}</h3>
                                    <div class="performance-score-container">
                                        <span class="performance-score">${perfScore.toFixed(0)}</span>
                                        <span class="performance-score-label">/100</span>
                                    </div>
                                    <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                                </div>
                                <div class="farm-card-body">
                                    <div class="metric-row">
                                        <span class="metric-label">${tempIcon} Temperature</span>
                                        <span class="metric-value">${data.avg_temp.toFixed(2)}Â°C</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${humidityIcon} Humidity</span>
                                        <span class="metric-value">${data.avg_humidity.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${spoilageIcon} Spoilage</span>
                                        <span class="metric-value">${data.avg_spoilage.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${shelfLifeIcon} Shelf Life</span>
                                        <span class="metric-value">${data.avg_shelf_life.toFixed(1)} days</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-suggestion-box" id="storageSuggestion">${aiSuggestionHTML}</div>
                        </div>
                    </div>
                `;
                
                const ctx = document.getElementById('storageChart1').getContext('2d');
                if (charts.storageChart1) charts.storageChart1.destroy();
                charts.storageChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Temperature (Â°C)', 'Humidity (%)', 'Spoilage (%)', 'Shelf Life (days)'],
                        datasets: [{
                            label: 'Storage Metrics',
                            data: [data.avg_temp, data.avg_humidity, data.avg_spoilage, data.avg_shelf_life],
                            backgroundColor: ['#3498db', '#9b59b6', '#e74c3c', '#27ae60']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading storage data:', err);
                document.getElementById('storage-container').innerHTML = '<p>Error loading data. Please ensure the farm CSV file exists.</p>';
            }
        }

        async function loadComparisonProcessing() {
            try {
                const [comparisonData, aiData] = await Promise.all([
                    fetch('/api/comparison/processing').then(r => {
                        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                        return r.json();
                    }),
                    loadAIInsights('processing').catch(() => ({ insights: [], recommendations: [], farm_insights: {} }))
                ]);

                const farms = Object.keys(comparisonData);
                let html = '';
                const farmIcon = getIcon('farm', 'lg');
                const defectsIcon = getIcon('defects', 'sm');
                const machineryIcon = getIcon('machinery', 'sm');
                const processingIcon = getIcon('processing', 'sm');
                
                farms.forEach(farm => {
                    const data = comparisonData[farm];
                    if (!data) {
                        console.error(`No data for farm: ${farm}`);
                        return;
                    }
                    const farmInsight = aiData.farm_insights && aiData.farm_insights[farm] ? aiData.farm_insights[farm] : '';
                    const avg_defect_rate = data.avg_defect_rate || 0;
                    const avg_uptime = data.avg_uptime || 0;
                    const avg_packaging_speed = data.avg_packaging_speed || 0;
                    const perfScore = avg_defect_rate < 3 && avg_uptime > 90 ? 80 : avg_defect_rate < 5 && avg_uptime > 85 ? 65 : 50;
                    const perfClass = getPerformanceClass(perfScore);
                    html += `
                        <div class="farm-card ${perfClass}">
                            <div class="farm-card-header">
                                <h3>${farmIcon} ${farm}</h3>
                                <div class="performance-score-container">
                                    <span class="performance-score">${perfScore.toFixed(0)}</span>
                                    <span class="performance-score-label">/100</span>
                                </div>
                                <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                            </div>
                            <div class="farm-card-body">
                                <div class="metric-row">
                                    <span class="metric-label">${defectsIcon} Defect Rate</span>
                                    <span class="metric-value">${avg_defect_rate.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${machineryIcon} Machinery Uptime</span>
                                    <span class="metric-value">${avg_uptime.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${processingIcon} Packaging Speed</span>
                                    <span class="metric-value">${avg_packaging_speed.toFixed(1)} units/min</span>
                                </div>
                            </div>
                        </div>`;
                });
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All farms performing well'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Comparison', insights, recommendations, true);
                
                document.getElementById('processing-container').innerHTML = `
                    <div class="farm-comparison">
                        ${html}
                    </div>
                    <div class="ai-suggestion-box side-by-side" id="processingSuggestion">${aiSuggestionHTML}</div>
                `;
                
                const ctx = document.getElementById('processingChart1').getContext('2d');
                if (charts.processingChart1) charts.processingChart1.destroy();
                const allProcesses = new Set();
                farms.forEach(farm => {
                    if (comparisonData[farm] && comparisonData[farm].defect_by_process) {
                        Object.keys(comparisonData[farm].defect_by_process).forEach(proc => allProcesses.add(proc));
                    }
                });
                const processLabels = Array.from(allProcesses);
                
                if (processLabels.length > 0) {
                    charts.processingChart1 = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: processLabels,
                            datasets: farms.map((farm, idx) => ({
                                label: farm,
                                data: processLabels.map(proc => (comparisonData[farm] && comparisonData[farm].defect_by_process && comparisonData[farm].defect_by_process[proc]) || 0),
                                backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12'][idx]
                            }))
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                } else {
                    charts.processingChart1 = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: farms,
                            datasets: [{
                                label: 'Defect Rate (%)',
                                data: farms.map(f => comparisonData[f].avg_defect_rate),
                                backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            } catch (err) {
                console.error('Error loading comparison data:', err);
                document.getElementById('processing-container').innerHTML = '<p>Error loading data.</p>';
            }
        }

        async function loadProcessingData() {
            if (currentFarm === 'all') {
                loadComparisonProcessing();
                return;
            }
            
            try {
                const [data, aiData] = await Promise.all([
                    fetch(`/api/farm/${currentFarm}/processing`).then(r => r.json()),
                    loadAIInsights('processing')
                ]);
                
                const perfScore = data.avg_defect_rate < 3 && data.avg_uptime > 90 ? 85 : data.avg_defect_rate < 5 && data.avg_uptime > 85 ? 70 : data.avg_defect_rate < 7 ? 55 : 40;
                const perfClass = getPerformanceClass(perfScore);
                const farmIcon = getIcon('farm', 'lg');
                const defectsIcon = getIcon('defects', 'sm');
                const machineryIcon = getIcon('machinery', 'sm');
                const processingIcon = getIcon('processing', 'sm');
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All metrics optimal'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Analysis', insights, recommendations);
                
                // Create side-by-side layout: Farm card and AI box
                document.getElementById('processing-container').innerHTML = `
                    <div class="farm-stage-container">
                        <div class="farm-stage-cards">
                            <div class="farm-card ${perfClass}">
                                <div class="farm-card-header">
                                    <h3>${farmIcon} ${currentFarm}</h3>
                                    <div class="performance-score-container">
                                        <span class="performance-score">${perfScore.toFixed(0)}</span>
                                        <span class="performance-score-label">/100</span>
                                    </div>
                                    <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                                </div>
                                <div class="farm-card-body">
                                    <div class="metric-row">
                                        <span class="metric-label">${defectsIcon} Defect Rate</span>
                                        <span class="metric-value">${data.avg_defect_rate.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${machineryIcon} Machinery Uptime</span>
                                        <span class="metric-value">${data.avg_uptime.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${processingIcon} Packaging Speed</span>
                                        <span class="metric-value">${data.avg_packaging_speed.toFixed(1)} units/min</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-suggestion-box" id="processingSuggestion">${aiSuggestionHTML}</div>
                        </div>
                    </div>
                `;
                
                const ctx = document.getElementById('processingChart1').getContext('2d');
                if (charts.processingChart1) charts.processingChart1.destroy();
                charts.processingChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.defect_by_process),
                        datasets: [{
                            label: 'Defect Rate (%)',
                            data: Object.values(data.defect_by_process),
                            backgroundColor: '#e74c3c'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading processing data:', err);
                document.getElementById('processing-kpis').innerHTML = '<p>Error loading data. Please ensure the farm CSV file exists.</p>';
            }
        }

        async function loadComparisonTransportation() {
            try {
                const [comparisonData, aiData] = await Promise.all([
                    fetch('/api/comparison/transportation').then(r => {
                        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                        return r.json();
                    }),
                    loadAIInsights('transportation').catch(() => ({ insights: [], recommendations: [], farm_insights: {} }))
                ]);

                const farms = Object.keys(comparisonData);
                let html = '';
                
                farms.forEach(farm => {
                    const data = comparisonData[farm];
                    if (!data) {
                        console.error(`No data for farm: ${farm}`);
                        return;
                    }
                    const insight = aiData.farm_insights && aiData.farm_insights[farm] ? aiData.farm_insights[farm] : 'All metrics optimal';
                    const delay_percentage = data.delay_percentage || 0;
                    const avg_distance = data.avg_distance || 0;
                    const avg_fuel = data.avg_fuel || 0;
                    const avg_delivery_time = data.avg_delivery_time || 0;
                    const perfScore = delay_percentage < 10 ? 80 : delay_percentage < 15 ? 65 : 50;
                    const perfClass = getPerformanceClass(perfScore);
                    const farmIcon = getIcon('farm', 'lg');
                    const transportationIcon = getIcon('transportation', 'sm');
                    const delaysIcon = getIcon('delays', 'sm');
                    const fuelIcon = getIcon('fuel', 'sm');
                    const distanceIcon = getIcon('distance', 'sm');
                    
                    html += `
                        <div class="farm-card ${perfClass}">
                            <div class="farm-card-header">
                                <h3>${farmIcon} ${farm}</h3>
                                <div class="performance-score-container">
                                    <span class="performance-score">${perfScore.toFixed(0)}</span>
                                    <span class="performance-score-label">/100</span>
                                </div>
                                <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                            </div>
                            <div class="farm-card-body">
                                <div class="metric-row">
                                    <span class="metric-label">${transportationIcon} Delays</span>
                                    <span class="metric-value">${delay_percentage.toFixed(1)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${distanceIcon} Distance</span>
                                    <span class="metric-value">${avg_distance.toFixed(0)} km</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${fuelIcon} Fuel Usage</span>
                                    <span class="metric-value">${avg_fuel.toFixed(1)} L/100km</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${delaysIcon} Delivery Time</span>
                                    <span class="metric-value">${avg_delivery_time.toFixed(1)} hrs</span>
                                </div>
                            </div>
                        </div>`;
                });
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All farms performing well'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Comparison', insights, recommendations, true);
                
                document.getElementById('transportation-container').innerHTML = `
                    <div class="farm-comparison">
                        ${html}
                    </div>
                    <div class="ai-suggestion-box side-by-side" id="transportationSuggestion">${aiSuggestionHTML}</div>
                `;
                
                const ctx = document.getElementById('transChart1').getContext('2d');
                if (charts.transChart1) charts.transChart1.destroy();
                charts.transChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: farms,
                        datasets: [{
                            label: 'Delay %',
                            data: farms.map(f => comparisonData[f].delay_percentage),
                            backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading comparison data:', err);
                document.getElementById('transportation-container').innerHTML = '<p>Error loading data.</p>';
            }
        }

        async function loadTransportationData() {
            if (currentFarm === 'all') {
                loadComparisonTransportation();
                return;
            }
            
            try {
                const [data, aiData] = await Promise.all([
                    fetch(`/api/farm/${currentFarm}/transportation`).then(r => r.json()),
                    loadAIInsights('transportation')
                ]);
                
                const perfScore = data.delay_percentage < 10 ? 85 : data.delay_percentage < 15 ? 70 : data.delay_percentage < 20 ? 55 : 40;
                const perfClass = getPerformanceClass(perfScore);
                const farmIcon = getIcon('farm', 'lg');
                const transportationIcon = getIcon('transportation', 'sm');
                const delaysIcon = getIcon('delays', 'sm');
                const fuelIcon = getIcon('fuel', 'sm');
                const distanceIcon = getIcon('distance', 'sm');
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All metrics optimal'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Analysis', insights, recommendations);
                
                // Create side-by-side layout: Farm card and AI box
                document.getElementById('transportation-container').innerHTML = `
                    <div class="farm-stage-container">
                        <div class="farm-stage-cards">
                            <div class="farm-card ${perfClass}">
                                <div class="farm-card-header">
                                    <h3>${farmIcon} ${currentFarm}</h3>
                                    <div class="performance-score-container">
                                        <span class="performance-score">${perfScore.toFixed(0)}</span>
                                        <span class="performance-score-label">/100</span>
                                    </div>
                                    <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                                </div>
                                <div class="farm-card-body">
                                    <div class="metric-row">
                                        <span class="metric-label">${transportationIcon} Delays</span>
                                        <span class="metric-value">${data.delay_percentage.toFixed(1)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${distanceIcon} Distance</span>
                                        <span class="metric-value">${data.avg_distance.toFixed(0)} km</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${fuelIcon} Fuel Usage</span>
                                        <span class="metric-value">${data.avg_fuel.toFixed(1)} L/100km</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${delaysIcon} Delivery Time</span>
                                        <span class="metric-value">${data.avg_delivery_time.toFixed(1)} hrs</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-suggestion-box" id="transportationSuggestion">${aiSuggestionHTML}</div>
                        </div>
                    </div>
                `;
                
                const ctx = document.getElementById('transChart1').getContext('2d');
                if (charts.transChart1) charts.transChart1.destroy();
                charts.transChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Distance (km)', 'Fuel (L/100km)', 'Delivery Time (hrs)', 'Delays (%)'],
                        datasets: [{
                            label: 'Transportation Metrics',
                            data: [data.avg_distance / 10, data.avg_fuel, data.avg_delivery_time, data.delay_percentage],
                            backgroundColor: ['#3498db', '#f39c12', '#27ae60', '#e74c3c']
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (err) {
                console.error('Error loading transportation data:', err);
                document.getElementById('transportation-container').innerHTML = '<p>Error loading data. Please ensure the farm CSV file exists.</p>';
            }
        }

        async function loadComparisonRetail() {
            try {
                const [comparisonData, aiData] = await Promise.all([
                    fetch('/api/comparison/retail').then(r => {
                        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                        return r.json();
                    }),
                    loadAIInsights('retail').catch(() => ({ insights: [], recommendations: [], farm_insights: {} }))
                ]);

                const farms = Object.keys(comparisonData);
                let html = '';
                
                farms.forEach(farm => {
                    const data = comparisonData[farm];
                    if (!data) {
                        console.error(`No data for farm: ${farm}`);
                        return;
                    }
                    const insight = aiData.farm_insights && aiData.farm_insights[farm] ? aiData.farm_insights[farm] : 'All metrics optimal';
                    const avg_waste = data.avg_waste || 0;
                    const total_inventory = data.total_inventory || 0;
                    const avg_sales_velocity = data.avg_sales_velocity || 0;
                    const avg_pricing_index = data.avg_pricing_index || 0;
                    const perfScore = avg_waste < 10 ? 80 : avg_waste < 12 ? 65 : 50;
                    const perfClass = getPerformanceClass(perfScore);
                    const farmIcon = getIcon('farm', 'lg');
                    const wasteIcon = getIcon('waste_icon', 'sm');
                    const inventoryIcon = getIcon('inventory', 'sm');
                    const salesIcon = getIcon('sales', 'sm');
                    
                    html += `
                        <div class="farm-card ${perfClass}">
                            <div class="farm-card-header">
                                <h3>${farmIcon} ${farm}</h3>
                                <div class="performance-score-container">
                                    <span class="performance-score">${perfScore.toFixed(0)}</span>
                                    <span class="performance-score-label">/100</span>
                                </div>
                                <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                            </div>
                            <div class="farm-card-body">
                                <div class="metric-row">
                                    <span class="metric-label">${wasteIcon} Waste</span>
                                    <span class="metric-value">${avg_waste.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${inventoryIcon} Inventory</span>
                                    <span class="metric-value">${(total_inventory/1000).toFixed(0)}k units</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${salesIcon} Sales Velocity</span>
                                    <span class="metric-value">${avg_sales_velocity.toFixed(1)} units/day</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${salesIcon} Pricing Index</span>
                                    <span class="metric-value">${avg_pricing_index.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>`;
                });
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All farms performing well'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Comparison', insights, recommendations, true);
                
                document.getElementById('retail-container').innerHTML = `
                    <div class="farm-comparison">
                        ${html}
                    </div>
                    <div class="ai-suggestion-box side-by-side" id="retailSuggestion">${aiSuggestionHTML}</div>
                `;
                
                const ctx = document.getElementById('retailChart1').getContext('2d');
                if (charts.retailChart1) charts.retailChart1.destroy();
                charts.retailChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: farms,
                        datasets: [{
                            label: 'Waste %',
                            data: farms.map(f => comparisonData[f].avg_waste),
                            backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading comparison data:', err);
                document.getElementById('retail-container').innerHTML = '<p>Error loading data.</p>';
            }
        }

        async function loadRetailData() {
            if (currentFarm === 'all') {
                loadComparisonRetail();
                return;
            }
            
            try {
                const [data, aiData] = await Promise.all([
                    fetch(`/api/farm/${currentFarm}/retail`).then(r => r.json()),
                    loadAIInsights('retail')
                ]);
                
                const perfScore = data.avg_waste < 10 ? 85 : data.avg_waste < 12 ? 70 : data.avg_waste < 15 ? 55 : 40;
                const perfClass = getPerformanceClass(perfScore);
                const farmIcon = getIcon('farm', 'lg');
                const wasteIcon = getIcon('waste_icon', 'sm');
                const inventoryIcon = getIcon('inventory', 'sm');
                const salesIcon = getIcon('sales', 'sm');
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All metrics optimal'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Analysis', insights, recommendations);
                
                // Create side-by-side layout: Farm card and AI box
                document.getElementById('retail-container').innerHTML = `
                    <div class="farm-stage-container">
                        <div class="farm-stage-cards">
                            <div class="farm-card ${perfClass}">
                                <div class="farm-card-header">
                                    <h3>${farmIcon} ${currentFarm}</h3>
                                    <div class="performance-score-container">
                                        <span class="performance-score">${perfScore.toFixed(0)}</span>
                                        <span class="performance-score-label">/100</span>
                                    </div>
                                    <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                                </div>
                                <div class="farm-card-body">
                                    <div class="metric-row">
                                        <span class="metric-label">${wasteIcon} Waste</span>
                                        <span class="metric-value">${data.avg_waste.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${inventoryIcon} Inventory</span>
                                        <span class="metric-value">${data.total_inventory.toFixed(0)} units</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${salesIcon} Sales Velocity</span>
                                        <span class="metric-value">${data.avg_sales_velocity.toFixed(1)} units/day</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${salesIcon} Pricing Index</span>
                                        <span class="metric-value">${data.avg_pricing_index.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-suggestion-box" id="retailSuggestion">${aiSuggestionHTML}</div>
                        </div>
                    </div>
                `;
                
                const ctx = document.getElementById('retailChart1').getContext('2d');
                if (charts.retailChart1) charts.retailChart1.destroy();
                charts.retailChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Inventory (units)', 'Sales Velocity (units/day)', 'Pricing Index', 'Waste (%)'],
                        datasets: [{
                            label: 'Retail Metrics',
                            data: [data.total_inventory / 1000, data.avg_sales_velocity, data.avg_pricing_index * 100, data.avg_waste],
                            backgroundColor: ['#3498db', '#27ae60', '#f39c12', '#e74c3c']
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (err) {
                console.error('Error loading retail data:', err);
                document.getElementById('retail-container').innerHTML = '<p>Error loading data. Please ensure the farm CSV file exists.</p>';
            }
        }

        async function loadComparisonConsumption() {
            try {
                const [comparisonData, aiData] = await Promise.all([
                    fetch('/api/comparison/consumption').then(r => {
                        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                        return r.json();
                    }),
                    loadAIInsights('consumption').catch(() => ({ insights: [], recommendations: [], farm_insights: {} }))
                ]);

                const farms = Object.keys(comparisonData);
                let html = '';
                
                farms.forEach(farm => {
                    const data = comparisonData[farm];
                    if (!data) {
                        console.error(`No data for farm: ${farm}`);
                        return;
                    }
                    const insight = aiData.farm_insights && aiData.farm_insights[farm] ? aiData.farm_insights[farm] : 'All metrics optimal';
                    const avg_satisfaction = data.avg_satisfaction || 0;
                    const avg_household_waste = data.avg_household_waste || 0;
                    const avg_recipe_accuracy = data.avg_recipe_accuracy || 0;
                    const perfScore = avg_satisfaction > 8 ? 80 : avg_satisfaction > 7 ? 65 : 50;
                    const perfClass = getPerformanceClass(perfScore);
                    const farmIcon = getIcon('farm', 'lg');
                    const satisfactionIcon = getIcon('satisfaction', 'sm');
                    const householdIcon = getIcon('household', 'sm');
                    const processingIcon = getIcon('processing', 'sm');
                    
                    html += `
                        <div class="farm-card ${perfClass}">
                            <div class="farm-card-header">
                                <h3>${farmIcon} ${farm}</h3>
                                <div class="performance-score-container">
                                    <span class="performance-score">${perfScore.toFixed(0)}</span>
                                    <span class="performance-score-label">/100</span>
                                </div>
                                <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                            </div>
                            <div class="farm-card-body">
                                <div class="metric-row">
                                    <span class="metric-label">${satisfactionIcon} Satisfaction</span>
                                    <span class="metric-value">${avg_satisfaction.toFixed(1)}/10</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${householdIcon} Household Waste</span>
                                    <span class="metric-value">${avg_household_waste.toFixed(2)} kg</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${processingIcon} Recipe Accuracy</span>
                                    <span class="metric-value">${avg_recipe_accuracy.toFixed(2)}%</span>
                                </div>
                            </div>
                        </div>`;
                });
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All farms performing well'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Comparison', insights, recommendations, true);
                
                document.getElementById('consumption-container').innerHTML = `
                    <div class="farm-comparison">
                        ${html}
                    </div>
                    <div class="ai-suggestion-box side-by-side" id="consumptionSuggestion">${aiSuggestionHTML}</div>
                `;
                
                const ctx = document.getElementById('consumptionChart1').getContext('2d');
                if (charts.consumptionChart1) charts.consumptionChart1.destroy();
                charts.consumptionChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: farms,
                        datasets: [{
                            label: 'Satisfaction',
                            data: farms.map(f => comparisonData[f].avg_satisfaction),
                            backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading comparison data:', err);
                document.getElementById('consumption-container').innerHTML = '<p>Error loading data.</p>';
            }
        }

        async function loadConsumptionData() {
            if (currentFarm === 'all') {
                loadComparisonConsumption();
                return;
            }
            
            try {
                const [data, aiData] = await Promise.all([
                    fetch(`/api/farm/${currentFarm}/consumption`).then(r => r.json()),
                    loadAIInsights('consumption')
                ]);
                
                const perfScore = data.avg_satisfaction > 8 ? 85 : data.avg_satisfaction > 7 ? 70 : data.avg_satisfaction > 6 ? 55 : 40;
                const perfClass = getPerformanceClass(perfScore);
                const farmIcon = getIcon('farm', 'lg');
                const satisfactionIcon = getIcon('satisfaction', 'sm');
                const householdIcon = getIcon('household', 'sm');
                const processingIcon = getIcon('processing', 'sm');
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All metrics optimal'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Analysis', insights, recommendations);
                
                // Create side-by-side layout: Farm card and AI box
                document.getElementById('consumption-container').innerHTML = `
                    <div class="farm-stage-container">
                        <div class="farm-stage-cards">
                            <div class="farm-card ${perfClass}">
                                <div class="farm-card-header">
                                    <h3>${farmIcon} ${currentFarm}</h3>
                                    <div class="performance-score-container">
                                        <span class="performance-score">${perfScore.toFixed(0)}</span>
                                        <span class="performance-score-label">/100</span>
                                    </div>
                                    <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                                </div>
                                <div class="farm-card-body">
                                    <div class="metric-row">
                                        <span class="metric-label">${satisfactionIcon} Satisfaction</span>
                                        <span class="metric-value">${data.avg_satisfaction.toFixed(1)}/10</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${householdIcon} Household Waste</span>
                                        <span class="metric-value">${data.avg_household_waste.toFixed(2)} kg</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${processingIcon} Recipe Accuracy</span>
                                        <span class="metric-value">${data.avg_recipe_accuracy.toFixed(2)}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-suggestion-box" id="consumptionSuggestion">${aiSuggestionHTML}</div>
                        </div>
                    </div>
                `;
                
                const ctx = document.getElementById('consumptionChart1').getContext('2d');
                if (charts.consumptionChart1) charts.consumptionChart1.destroy();
                charts.consumptionChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Household Waste (kg)', 'Recipe Accuracy (%)', 'Satisfaction (/10)'],
                        datasets: [{
                            label: 'Consumption Metrics',
                            data: [data.avg_household_waste, data.avg_recipe_accuracy, data.avg_satisfaction * 10],
                            backgroundColor: ['#e74c3c', '#3498db', '#27ae60']
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (err) {
                console.error('Error loading consumption data:', err);
                document.getElementById('consumption-container').innerHTML = '<p>Error loading data. Please ensure the farm CSV file exists.</p>';
            }
        }

        async function loadComparisonWaste() {
            try {
                const [comparisonData, aiData] = await Promise.all([
                    fetch('/api/comparison/waste').then(r => {
                        if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
                        return r.json();
                    }),
                    loadAIInsights('waste').catch(() => ({ insights: [], recommendations: [], farm_insights: {} }))
                ]);

                const farms = Object.keys(comparisonData);
                let html = '';
                
                farms.forEach(farm => {
                    const data = comparisonData[farm];
                    if (!data) {
                        console.error(`No data for farm: ${farm}`);
                        return;
                    }
                    const insight = aiData.farm_insights && aiData.farm_insights[farm] ? aiData.farm_insights[farm] : 'All metrics optimal';
                    const avg_segregation = data.avg_segregation || 0;
                    const avg_upcycling = data.avg_upcycling || 0;
                    const avg_biogas = data.avg_biogas || 0;
                    const perfScore = avg_segregation > 85 && avg_upcycling > 60 ? 80 : avg_segregation > 75 && avg_upcycling > 50 ? 65 : 50;
                    const perfClass = getPerformanceClass(perfScore);
                    const farmIcon = getIcon('farm', 'lg');
                    const wasteIcon = getIcon('waste', 'sm');
                    const processingIcon = getIcon('processing', 'sm');
                    
                    html += `
                        <div class="farm-card ${perfClass}">
                            <div class="farm-card-header">
                                <h3>${farmIcon} ${farm}</h3>
                                <div class="performance-score-container">
                                    <span class="performance-score">${perfScore.toFixed(0)}</span>
                                    <span class="performance-score-label">/100</span>
                                </div>
                                <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                            </div>
                            <div class="farm-card-body">
                                <div class="metric-row">
                                    <span class="metric-label">${wasteIcon} Segregation</span>
                                    <span class="metric-value">${avg_segregation.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${wasteIcon} Upcycling Rate</span>
                                    <span class="metric-value">${avg_upcycling.toFixed(2)}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">${processingIcon} Biogas Output</span>
                                    <span class="metric-value">${avg_biogas.toFixed(1)} mÂ³</span>
                                </div>
                            </div>
                        </div>`;
                });
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All farms performing well'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Comparison', insights, recommendations, true);
                
                document.getElementById('waste-container').innerHTML = `
                    <div class="farm-comparison">
                        ${html}
                    </div>
                    <div class="ai-suggestion-box side-by-side" id="wasteSuggestion">${aiSuggestionHTML}</div>
                `;
                
                const ctx = document.getElementById('wasteChart1').getContext('2d');
                if (charts.wasteChart1) charts.wasteChart1.destroy();
                charts.wasteChart1 = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: farms,
                        datasets: [{
                            label: 'Segregation %',
                            data: farms.map(f => comparisonData[f].avg_segregation),
                            backgroundColor: ['#27ae60', '#3498db', '#e74c3c', '#f39c12']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading comparison data:', err);
                document.getElementById('waste-container').innerHTML = '<p>Error loading data.</p>';
            }
        }

        async function loadWasteData() {
            if (currentFarm === 'all') {
                loadComparisonWaste();
                return;
            }
            
            try {
                const [data, aiData] = await Promise.all([
                    fetch(`/api/farm/${currentFarm}/waste`).then(r => r.json()),
                    loadAIInsights('waste')
                ]);
                
                const perfScore = data.avg_segregation > 85 && data.avg_upcycling > 60 ? 85 : data.avg_segregation > 75 && data.avg_upcycling > 50 ? 70 : data.avg_segregation > 65 ? 55 : 40;
                const perfClass = getPerformanceClass(perfScore);
                const farmIcon = getIcon('farm', 'lg');
                const wasteIcon = getIcon('waste', 'sm');
                const processingIcon = getIcon('processing', 'sm');
                
                const insights = aiData.insights && aiData.insights.length > 0 ? aiData.insights : ['All metrics optimal'];
                const recommendations = aiData.recommendations || [];
                const aiSuggestionHTML = createAISuggestion('AI Analysis', insights, recommendations);
                
                // Create side-by-side layout: Farm card and AI box
                document.getElementById('waste-container').innerHTML = `
                    <div class="farm-stage-container">
                        <div class="farm-stage-cards">
                            <div class="farm-card ${perfClass}">
                                <div class="farm-card-header">
                                    <h3>${farmIcon} ${currentFarm}</h3>
                                    <div class="performance-score-container">
                                        <span class="performance-score">${perfScore.toFixed(0)}</span>
                                        <span class="performance-score-label">/100</span>
                                    </div>
                                    <span class="status-badge ${perfClass}">${getStatusText(perfScore)}</span>
                                </div>
                                <div class="farm-card-body">
                                    <div class="metric-row">
                                        <span class="metric-label">${wasteIcon} Segregation</span>
                                        <span class="metric-value">${data.avg_segregation.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${wasteIcon} Upcycling Rate</span>
                                        <span class="metric-value">${data.avg_upcycling.toFixed(2)}%</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">${processingIcon} Biogas Output</span>
                                        <span class="metric-value">${data.avg_biogas.toFixed(1)} mÂ³</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ai-suggestion-box" id="wasteSuggestion">${aiSuggestionHTML}</div>
                        </div>
                    </div>
                `;
                
                const ctx = document.getElementById('wasteChart1').getContext('2d');
                if (charts.wasteChart1) charts.wasteChart1.destroy();
                charts.wasteChart1 = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(data.waste_dist),
                        datasets: [{
                            data: Object.values(data.waste_dist),
                            backgroundColor: ['#27ae60', '#3498db', '#f39c12']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch (err) {
                console.error('Error loading waste data:', err);
                document.getElementById('waste-container').innerHTML = '<p>Error loading data. Please ensure the farm CSV file exists.</p>';
            }
        }

        function viewFarmDetails(stage) {
            if (currentFarm === 'all') {
                // Show comparison details for all farms
                window.location.href = `/details/all/${stage}`;
            } else {
                // Show details for specific farm
                window.location.href = `/details/${currentFarm}/${stage}`;
            }
        }

        // Initialize icons
        function initializeIcons() {
            // Sidebar icons
            document.getElementById('sidebar-overview-icon').innerHTML = getIcon('overview', 'lg');
            document.getElementById('sidebar-production-icon').innerHTML = getIcon('production', 'lg');
            document.getElementById('sidebar-storage-icon').innerHTML = getIcon('storage', 'lg');
            document.getElementById('sidebar-processing-icon').innerHTML = getIcon('processing', 'lg');
            document.getElementById('sidebar-transportation-icon').innerHTML = getIcon('transportation', 'lg');
            document.getElementById('sidebar-retail-icon').innerHTML = getIcon('retail', 'lg');
            document.getElementById('sidebar-consumption-icon').innerHTML = getIcon('consumption', 'lg');
            document.getElementById('sidebar-waste-icon').innerHTML = getIcon('waste', 'lg');
            document.getElementById('sidebar-security-icon').innerHTML = getIcon('security', 'lg');
            
            // Section title icons
            document.getElementById('overview-title-icon').innerHTML = getIcon('overview', 'xl');
            document.getElementById('production-title-icon').innerHTML = getIcon('production', 'xl');
            document.getElementById('storage-title-icon').innerHTML = getIcon('storage', 'xl');
            document.getElementById('processing-title-icon').innerHTML = getIcon('processing', 'xl');
            document.getElementById('transportation-title-icon').innerHTML = getIcon('transportation', 'xl');
            document.getElementById('retail-title-icon').innerHTML = getIcon('retail', 'xl');
            document.getElementById('consumption-title-icon').innerHTML = getIcon('consumption', 'xl');
            document.getElementById('waste-title-icon').innerHTML = getIcon('waste', 'xl');
            document.getElementById('security-title-icon').innerHTML = getIcon('security', 'xl');
            
            // Sparkle icons
            const sparkleIcon = getIcon('sparkle', 'sm');
            document.getElementById('overview-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('production-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('storage-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('processing-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('transportation-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('retail-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('consumption-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('waste-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('security-sparkle-icon').innerHTML = sparkleIcon;
            
            // Chart sparkle icons
            document.getElementById('chart1-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('chart2-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('chart3-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('chart4-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('production-chart-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('storage-chart-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('processing-chart-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('transportation-chart-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('retail-chart-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('consumption-chart-sparkle-icon').innerHTML = sparkleIcon;
            document.getElementById('waste-chart-sparkle-icon').innerHTML = sparkleIcon;
            
            // Button icons
            document.getElementById('production-button-icon').innerHTML = sparkleIcon;
            document.getElementById('storage-button-icon').innerHTML = sparkleIcon;
            document.getElementById('processing-button-icon').innerHTML = sparkleIcon;
            document.getElementById('transportation-button-icon').innerHTML = sparkleIcon;
            document.getElementById('retail-button-icon').innerHTML = sparkleIcon;
            document.getElementById('consumption-button-icon').innerHTML = sparkleIcon;
            document.getElementById('waste-button-icon').innerHTML = sparkleIcon;
            
            // Header AI icon
            document.getElementById('header-ai-icon').innerHTML = getIcon('ai', 'sm');
        }
        
        // Initialize - set "All Farms" as active by default
        initializeIcons();
        document.querySelector('.farm-tab').classList.add('active');
        loadOverviewData();
        
        // Check if security section is active on page load and set body class
        if (document.getElementById('security') && document.getElementById('security').classList.contains('active')) {
            document.body.classList.add('security-active');
        }
    </script>

    <!-- Chatbot UI - Must be before the initialization script -->
    <div class="chatbot-toggle" id="chatbotToggle">
        <svg viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
        </svg>
    </div>
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <h3>ðŸ¤– AI Assistant</h3>
            <button class="chatbot-close" id="chatbotClose">Ã—</button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages"></div>
        <div class="chatbot-input-container">
            <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Ask me anything about the farms...">
            <button class="chatbot-send" id="chatbotSend">Send</button>
        </div>
    </div>

    <script>
        // Chatbot functionality - initialize after elements are in DOM
        function initializeChatbot() {
            let chatbotOpen = false;
            const chatbotToggle = document.getElementById('chatbotToggle');
            const chatbotContainer = document.getElementById('chatbotContainer');
            const chatbotClose = document.getElementById('chatbotClose');
            const chatbotInput = document.getElementById('chatbotInput');
            const chatbotSend = document.getElementById('chatbotSend');
            const chatbotMessages = document.getElementById('chatbotMessages');

            if (!chatbotToggle || !chatbotContainer) {
                console.error('Chatbot elements not found', { chatbotToggle, chatbotContainer });
                return;
            }
            
            console.log('Chatbot initialized successfully');

            function addMessage(text, isUser = false) {
                if (!chatbotMessages) return;
                const messageDiv = document.createElement('div');
                messageDiv.className = `chatbot-message ${isUser ? 'user' : 'bot'}`;
                const contentDiv = document.createElement('div');
                contentDiv.className = 'chatbot-message-content';
                
                // Split by newlines and create elements for each line
                const lines = text.split('\n');
                lines.forEach((line, index) => {
                    if (index > 0) {
                        contentDiv.appendChild(document.createElement('br'));
                    }
                    contentDiv.appendChild(document.createTextNode(line));
                });
                
                messageDiv.appendChild(contentDiv);
                chatbotMessages.appendChild(messageDiv);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            function addTypingIndicator() {
                if (!chatbotMessages) return;
                const typingDiv = document.createElement('div');
                typingDiv.className = 'chatbot-message bot';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = '<div class="chatbot-typing"><span></span><span></span><span></span></div>';
                chatbotMessages.appendChild(typingDiv);
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }

            function removeTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) indicator.remove();
            }

            async function sendMessage() {
                if (!chatbotInput || !chatbotSend) return;
                const message = chatbotInput.value.trim();
                if (!message) return;

                addMessage(message, true);
                chatbotInput.value = '';
                chatbotSend.disabled = true;
                addTypingIndicator();

                try {
                    const response = await fetch('/api/chatbot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message })
                    });

                    const data = await response.json();
                    removeTypingIndicator();
                    addMessage(data.response);
                } catch (error) {
                    removeTypingIndicator();
                    addMessage("Sorry, I encountered an error. Please try again.");
                    console.error('Chatbot error:', error);
                } finally {
                    if (chatbotSend) chatbotSend.disabled = false;
                    if (chatbotInput) chatbotInput.focus();
                }
            }

            chatbotToggle.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('Chatbot toggle clicked');
                chatbotOpen = !chatbotOpen;
                chatbotContainer.classList.toggle('active', chatbotOpen);
                console.log('Chatbot open:', chatbotOpen);
                if (chatbotOpen) {
                    if (chatbotInput) chatbotInput.focus();
                    if (chatbotMessages && chatbotMessages.children.length === 0) {
                        addMessage("Hello! I'm your AI assistant for the Food Supply Chain Platform. I can answer questions about any farm, metrics, performance, and insights. What would you like to know?");
                    }
                }
            });

            if (chatbotClose) {
                chatbotClose.addEventListener('click', () => {
                    chatbotOpen = false;
                    chatbotContainer.classList.remove('active');
                });
            }

            if (chatbotSend) {
                chatbotSend.addEventListener('click', sendMessage);
            }

            if (chatbotInput) {
                chatbotInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        }

        // Initialize chatbot - try multiple times to ensure elements exist
        function tryInitializeChatbot() {
            const chatbotToggle = document.getElementById('chatbotToggle');
            if (chatbotToggle) {
                initializeChatbot();
            } else {
                // Elements not ready yet, try again after a short delay
                setTimeout(tryInitializeChatbot, 50);
            }
        }

        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', tryInitializeChatbot);
        } else {
            // DOM is already loaded or loading
            tryInitializeChatbot();
        }
    </script>
</body>
</html>
